function TmaScreen(e,t,n){return e==TmaScreen.FULL_WIDTH&&(e=Math.max(document.body.clientWidth,document.body.scrollWidth,document.documentElement.scrollWidth,document.documentElement.clientWidth)),t==TmaScreen.FULL_HEIGHT&&(t=Math.max(document.body.clientHeight,document.body.scrollHeight,document.documentElement.scrollHeight,document.documentElement.clientHeight)),!n||TmaScreen.MODE_2D==n?new Tma2DScreen(e,t):new Tma3DScreen(e,t)}function Tma2DScreen(e,t){this.width=e,this.height=t,this.canvas=document.createElement("canvas"),this.canvas.width=e,this.canvas.height=t,this.canvas.onmousemove=this._onmousemove.bind(this),this.canvas.onmouseout=this._onmouseout.bind(this),this.canvas.onmousedown=this._onmousedown.bind(this),this.canvas.onmouseup=this._onmouseup.bind(this),this.context=this.canvas.getContext("2d"),this._image=this.context.getImageData(0,0,this.width,this.height),this.data=this._image.data,this._offscreenCanvas=document.createElement("canvas"),this._offscreenCanvas.width=e,this._offscreenCanvas.height=t,this._offscreenContext=this._offscreenCanvas.getContext("2d"),this._offscreenImage=this.createImageData(e,t),this._afterimage=0,this._blurCanvas=document.createElement("canvas"),this._blurCanvas.width=e,this._blurCanvas.height=t,this._blurContext=this._blurCanvas.getContext("2d"),this._blurRatio=0,this._blurAlpha=0,this._blurWidth=0,this._blurHeight=0,this._blurSource={x:0,y:0,w:0,h:0},this._blurDestination={x:0,y:0,w:0,h:0},this._blurSync=!0,this._mouse=!1,this._mouseX=0,this._mouseY=0,this._mousePressed=!1}function Tma3DScreen(e,t){this.width=e,this.height=t,this.canvas=document.createElement("canvas"),this.canvas.width=e,this.canvas.height=t,this.canvas.style.backgroundColor="#000000",this.canvas.onmousemove=this._onmousemove.bind(this),this.canvas.onmouseout=this._onmouseout.bind(this),this.canvas.onmousedown=this._onmousedown.bind(this),this.canvas.onmouseup=this._onmouseup.bind(this),this.canvas2d=document.createElement("canvas"),this.context=this.canvas2d.getContext("2d"),this.gl=this.canvas.getContext("webgl",{preserveDrawingBuffer:!0}),this.gl||(tma.log("WebGL: webgl is not supported. Try experimental-webgl..."),this.gl=this.canvas.getContext("experimental-webgl")),this.gl||(tma.log("WebGL: Try webkit-3d..."),this.gl=this.canvas.getContext("webkit-3d")),this.gl||tma.error("WebGL: not supported."),this.gl.getExtension("OES_texture_float")==null&&tma.log("WebGL: float texture is not supported."),this.gl.viewport(0,0,e,t),this.setAlphaMode(!1),this.setCullingMode(!1,!0),this._currentAlphaMode={},this._currentCullingMode={},this._alphaModeStack=[],this._cullingModeStack=[],this._lastBoundFrameBuffer=this,this._mouse=!1,this._mouseX=0,this._mouseY=0,this._mouseClickX=0,this._mouseClickY=0,this._mouseWidth=0,this._mouseHeight=0,tma.log("WebGL max vertex uniform vectors: "+this.gl.getParameter(this.gl.MAX_VERTEX_UNIFORM_VECTORS)),tma.log("WebGL max varying vectors: "+this.gl.getParameter(this.gl.MAX_VARYING_VECTORS)),tma.log("WebGL max fragment uniform vectors: "+this.gl.getParameter(this.gl.MAX_FRAGMENT_UNIFORM_VECTORS)),tma.log("WebGL max vertex attributes: "+this.gl.getParameter(this.gl.MAX_VERTEX_ATTRIBS)),Tma3DScreen._MODE_INITIALIZED||(Tma3DScreen.MODE_POINTS=this.gl.POINTS,Tma3DScreen.MODE_LINES=this.gl.LINES,Tma3DScreen.MODE_LINE_LOOP=this.gl.LINE_LOOP,Tma3DScreen.MODE_LINE_STRIP=this.gl.LINE_STRIP,Tma3DScreen.MODE_TRIANGLES=this.gl.TRIANGLES,Tma3DScreen.MODE_TRIANGLE_STRIP=this.gl.TRIANGLE_STRIP,Tma3DScreen.MODE_TRIANGLE_FAN=this.gl.TRIANGLE_FAN,Tma3DScreen.FILTER_NEAREST=this.gl.NEAREST,Tma3DScreen.FILTER_LINEAR=this.gl.LINEAR,Tma3DScreen._MODE_INITIALIZED=!0)}function TmaModelPrimitives(){this._vertices=[],this._coords=[],this._indices=[],this._colors=[],this._verticesBuffer=null,this._coordsBuffer=null,this._indicesBuffer=null,this._colorsBuffer=null,this._texture=null,this._mode=Tma3DScreen.MODE_TRIANGLES}function TmaParticle(e,t){this._container=e,this._offset=t,this.x=0,this.y=0,this.z=0,this.vx=0,this.vy=0,this.vz=0}function TmaSequencer(){this._elapsed=0,this._queue=[],this._active=[],this._finished=[]}function TmaMotionBvh(){this.frameLength=0,this.frameTime=0,this._frameData=[],this._root=null}function TmaModelPly(){this._vertices=[],this._normals=[],this._coord=[],this._indices=[]}function TmaModelPs2Ico(){this.shapes=0,this.frames=0,this._vertices=null,this._coord=null,this._texture=null,this._weights=null}var exports={},module={},global={},tma={base:"",ready:!0};tma.log=console.log.bind(console),tma.info=console.info.bind(console),tma.warn=console.warn.bind(console),tma.error=console.error.bind(console),tma.ecb=function(e){console.error(e)},tma._libraries={},tma._resources={},tma.basePath=function(){return tma.base},tma.load=function(e,t){if(!tma._libraries[e]){var n=new Promise(function(n,r){var i=document.createElement("script"),s={callbacks:[n],ready:!1,script:i};t&&s.callbacks.push(t),tma._libraries[e]=s,i.src=e,i.onload=function(){this.ready=!0;for(var e=0;e<this.callbacks.length;++e)this.callbacks[e]();this.callbacks=undefined}.bind(s),document.head.appendChild(i)});return n}return tma._libraries[e].ready?(t&&t(),new Promise(function(e,t){e()})):new Promise(function(n,r){var i=tma._libraries[e].callbacks;i.push(n),t&&i.push(t)})},tma.fetch=function(e,t,n){t||(t="arraybuffer");var r=t+":"+e;return n&&tma._resources[r]?tma._resources[r].ready?new Promise(function(e,t){e(tma_resources[r].resource)}):new Promise(function(e,t){tma._resources[r].callbacks.push(e)}):new Promise(function(i,s){n&&(tma._resources[r]={callbacks:[],ready:!1,resource:undefined});var o=new XMLHttpRequest;o.open("GET",e,!0),o.responseType=t,o.onload=function(){if(!this.response)s(this);else{i(this.response);if(n){var e=tma._resources[r];e.ready=!0,e.resource=this.response;for(var t=0;t<e.callbacks.length;++t)e.callbacks[t](this.response)}}this.onload=null}.bind(o),o.send()})},tma.loadShader=function(e,t){return new Promise(function(n,r){tma.fetch(e,"document",!0).then(function(e){n(e.getElementById(t).text)},tma.ecb)})},tma._boot=function(){var e=new Promise(function(e,t){tma.load(tma.base+"src/TmaScreen.js").then(function(){Promise.all([tma.load(tma.base+"src/Tma2DScreen.js"),new Promise(function(e,t){tma.load(tma.base+"src/Tma3DScreen.js",function(){tma.load(tma.base+"src/TmaModelPrimitives.js",e)},tma.ecb)},tma.ecb)]).then(function(){e()},tma.ecb)},tma.ecb)});Promise.all([e,tma.load(tma.base+"src/TmaParticle.js"),tma.load(tma.base+"src/TmaSequencer.js"),tma.load(tma.base+"src/TmaMotionBvh.js"),tma.load(tma.base+"src/TmaModelPly.js"),tma.load(tma.base+"src/TmaModelPs2Ico.js")]).then(function(){tma.ready=!0,Promise.all(tma.extlibs.map(function(e){return tma.load(tma.base+e)})).then(function(){tma.onload&&tma.onload()},tma.ebc)},tma.ecb)},TmaScreen.BODY=document.getElementsByTagName("body")[0],TmaScreen.LOCK=1,TmaScreen.LOCK_WITH_SCREEN=2,TmaScreen.MODE_2D=1,TmaScreen.MODE_3D=2,TmaScreen.FULL_WIDTH=-1,TmaScreen.FULL_HEIGHT=-1,TmaScreen.RGB2HSV=function(e,t,n){var r=0,i=0,s=0;return e>t?e>n?(r=e,i=t>n?n:t,s=60*(t-n)/(r-i)):(r=n,i=t,s=60*(e-t)/(r-i)+240):t>=n?(r=t,i=e>n?n:e,s=60*(n-e)/(r-i)+120):(r=n,i=e,s=60*(e-t)/(r-i)+240),{h:(s+360)%360,s:(r-i)/r,v:r/255}},TmaScreen.HSV2RGB=function(e,t,n){n*=255;var r=~~n;if(0==t)return{r:r,g:r,b:r};var i=e/60,s=~~i;i-=s;var o=~~(n*(1-t)),u=~~(n*(1-t*i)),a=~~(n*(1-t*(1-i)));switch(s){case 0:return{r:n,g:a,b:o};case 1:return{r:u,g:n,b:o};case 2:return{r:o,g:n,b:a};case 3:return{r:o,g:u,b:n};case 4:return{r:a,g:o,b:n};case 5:return{r:n,g:o,b:u}}},TmaScreen.prototype.setPixel=function(e,t,n,r,i,s,o){var u=(t*this.width+e)*4,a=this.data;if(o){var f=TmaScreen.HSV2RGB(n,r,i);a[u+0]=f.r,a[u+1]=f.g,a[u+2]=f.b,a[u+3]=s}else a[u+0]=n,a[u+1]=r,a[u+2]=i,a[u+3]=s},TmaScreen.prototype.addPixel=function(e,t,n,r,i,s,o){var u=(t*this.width+e)*4,a=this.data;if(o){var f=TmaScreen.HSV2RGB(n,r,i);a[u+0]+=f.r,a[u+1]+=f.g,a[u+2]+=f.b,a[u+3]=s}else a[u+0]+=n,a[u+1]+=r,a[u+2]+=i,a[u+3]=s},TmaScreen.prototype.drawLine=function(e,t,n,r,i,s,o,u,a,f){var l=(t*this.width+e)*4,c=this.data,h=i,p=s,d=o;if(a){var v=TmaScreen.HSV2RGB(i,s,o);h=v.r,p=v.g,d=v.b}var m=n-e,g=r-t,y=m>0?m:-m,b=g>0?g:-g;if(y<b){var w=g>0?1:-1,E=m/g,S=g>0?this.width*4:-this.width*4,x=4;if(f)for(var T=t;;T+=w){var N=l+~~(E*(T-t))*x;c[N+0]+=h,c[N+1]+=p,c[N+2]+=d,c[N+3]=u;if(T==r)break;l+=S}else for(T=t;;T+=w){N=l+~~(E*(T-t))*x,c[N+0]=h,c[N+1]=p,c[N+2]=d,c[N+3]=u;if(T==r)break;l+=S}}else{w=m>0?1:-1,E=g/m,S=this.width*4,x=m>0?4:-4;if(f)for(var C=e;;C+=w){N=l+~~(E*(C-e))*S,c[N+0]+=h,c[N+1]+=p,c[N+2]+=d,c[N+3]=u;if(C==n)break;l+=x}else for(C=e;;C+=w){N=l+~~(E*(C-e))*S,c[N+0]=h,c[N+1]=p,c[N+2]=d,c[N+3]=u;if(C==n)break;l+=x}}},exports.TmaScreen=TmaScreen,Tma2DScreen.prototype.attachTo=function(e){e.appendChild(this.canvas)},Tma2DScreen.prototype.detachFrom=function(e){e.removeChild(this.canvas)},Tma2DScreen.prototype.createImageData=function(e,t){return this.context.createImageData(e,t)},Tma2DScreen.prototype.setPixel=TmaScreen.prototype.setPixel,Tma2DScreen.prototype.addPixel=TmaScreen.prototype.addPixel,Tma2DScreen.prototype.drawLine=TmaScreen.prototype.drawLine,Tma2DScreen.prototype.lock=function(e){return TmaScreen.LOCK_WITH_SCREEN==e?this._image=this.context.getImageData(0,0,this.width,this.height):this._image=this._offscreenImage,this.data=this._image.data,this._image},Tma2DScreen.prototype.unlock=function(){this._blurRatio&&this._blurSync?this._offscreenContext.putImageData(this._image,0,0):this.context.putImageData(this._image,0,0),this.applyEffects()},Tma2DScreen.prototype.afterimage=function(e){this._afterimage=e},Tma2DScreen.prototype.blur=function(e,t,n,r,i,s){this._blurRatio=e,this._blurAlpha=t,this._blurWidth=~~(this.width*e),this._blurHeight=~~(this.height*e);var o=~~((this._blurWidth-this._blurWidth/n)/2),u=~~((this._blurHeight-this._blurHeight/n)/2);this._blurSource.x=o,this._blurSource.y=u,this._blurSource.w=this._blurWidth-o-o,this._blurSource.h=this._blurHeight-u-u,this._blurDestination.x=0,this._blurDestination.y=0,this._blurDestination.w=this.width,this._blurDestination.h=this.height;var a=r>=0?r:-r,f=i>=0?i:-i,l=~~(a*this._blurSource.w/this._blurDestination.w),c=~~(f*this._blurSource.h/this._blurDestination.h);this._blurSource.w-=l,this._blurDestination.w-=a,this._blurSource.h-=c,this._blurDestination.h-=f,r>0?this._blurSource.x+=l:r<0&&(this._blurDestination.x+=l),i>0?this._blurSource.y+=c:i<0&&(this._blurDestination.y+=c),this._blurSync=s},Tma2DScreen.prototype.fill=function(e){this.context.strokeStyle=e,this.context.fillStyle=e,this.context.fillRect(0,0,this.width,this.height)},Tma2DScreen.prototype.applyEffects=function(){this._applyBlur(),this._applyAfterimage()},Tma2DScreen.prototype._applyAfterimage=function(){if(!this._afterimage)return;this.fill(this._afterimage)},Tma2DScreen.prototype._applyBlur=function(){if(!this._blurRatio)return;var e,t;this._blurSync?(e=this._offscreenCanvas,t=this._offscreenContext):(e=this.canvas,t=this.context),this._blurContext.drawImage(e,0,0,this.width,this.height,0,0,this._blurWidth,this._blurHeight),t.globalCompositeOperation="lighter",t.globalAlpha=this._blurAlpha,t.drawImage(this._blurCanvas,this._blurSource.x,this._blurSource.y,this._blurSource.w,this._blurSource.h,this._blurDestination.x,this._blurDestination.y,this._blurDestination.w,this._blurDestination.h),t.globalCompositeOperation="source-over",t.globalAlpha=1,this._blurSync&&this.context.drawImage(e,0,0)},Tma2DScreen.prototype.mouse=function(){return this._mouse?{over:this._mouse,x:this._mouseX,y:this._mouseY}:{over:this._mouse}},Tma2DScreen.prototype._onmousemove=function(e){this._mouse=!0;var t=e.target.getBoundingClientRect();this._mouseX=e.clientX-t.left,this._mouseY=e.clientY-t.top,this._mousePressed&&this.onMouseDrag(this._mouseX,this._mouseY)},Tma2DScreen.prototype._onmouseout=function(e){this._mouse=!1},Tma2DScreen.prototype._onmousedown=function(e){var t=e.target.getBoundingClientRect();this._mouseX=e.clientX-t.left,this._mouseY=e.clientY-t.top,this._mousePressed=!0,this.onMouseDown(this._mouseX,this._mouseY),this.onMouseDrag(this._mouseX,this._mouseY)},Tma2DScreen.prototype._onmouseup=function(e){var t=e.target.getBoundingClientRect();this._mouseX=e.clientX-t.left,this._mouseY=e.clientY-t.top,this._mousePressed=!1,this.onMouseDrag(this._mouseX,this._mouseY),this.onMouseUp(this._mouseX,this._mouseY)},Tma2DScreen.prototype.onMouseDown=function(e,t){},Tma2DScreen.prototype.onMouseDrag=function(e,t){},Tma2DScreen.prototype.onMouseUp=function(e,t){},exports.Tma2DScreen=Tma2DScreen,Tma3DScreen.VERTEX_SHADER=1,Tma3DScreen.FRAGMENT_SHADER=2,Tma3DScreen._MODE_INITIALIZED=!1,Tma3DScreen.MODE_POINTS=0,Tma3DScreen.MODE_LINES=1,Tma3DScreen.MODE_LINE_LOOP=2,Tma3DScreen.MODE_LINE_STRIP=3,Tma3DScreen.MODE_TRIANGLES=4,Tma3DScreen.MODE_TRIANGLE_STRIP=5,Tma3DScreen.MODE_TRIANGLE_FAN=6,Tma3DScreen.FILTER_NEAREST=9728,Tma3DScreen.FILTER_LINEAR=9729,Tma3DScreen.prototype.attachTo=function(e){e.appendChild(this.canvas)},Tma3DScreen.prototype.detachFrom=function(e){e.removeChild(this.canvas)},Tma3DScreen.prototype.compileShader=function(e,t){var e=Tma3DScreen.VERTEX_SHADER==e?this.gl.VERTEX_SHADER:this.gl.FRAGMENT_SHADER,n=this.gl.createShader(e);return this.gl.shaderSource(n,t),this.gl.compileShader(n),this.gl.getShaderParameter(n,this.gl.COMPILE_STATUS)||tma.log("WebGL compiling shader: "+this.gl.getShaderInfoLog(n)+" : "+t),n},Tma3DScreen.prototype.loadShader=function(e,t){return this.compileShader(e,document.getElementById(t).text)},Tma3DScreen.prototype.linkProgram=function(e){this.gl.linkProgram(e),this.gl.getProgramParameter(e,this.gl.LINK_STATUS)||tma.log("WebGL link program error: "+this.gl.getProgramInfoLog(e)),tma.log("WebGL program active attributes "+this.gl.getProgramParameter(e,this.gl.ACTIVE_ATTRIBUTES))},Tma3DScreen.prototype.createProgram=function(e,t){var n=this.gl.createProgram();return e.constructor.name&&"WebGLShader"!=e.constructor.name&&(e=this.loadShader(Tma3DScreen.VERTEX_SHADER,e)),this.gl.attachShader(n,e),t.constructor.name&&"WebGLShader"!=t.constructor.name&&(t=this.loadShader(Tma3DScreen.FRAGMENT_SHADER,t)),this.gl.attachShader(n,t),this.linkProgram(n),n._owner=this,n._index=0,n._textureId=0,n._textureIdMap={},n._attributes={},n._uniforms={},n.attributeIndex=function(e){return this._attributes[e]||(this._attributes[e]=this._owner.gl.getAttribLocation(this,e)),this._attributes[e]},n.uniformIndex=function(e){return this._uniforms[e]||(this._uniforms[e]=this._owner.gl.getUniformLocation(this,e)),this._uniforms[e]},n.setAttribute=function(e,t){var n=this._attributeIndex(e);this._owner.setAttribute(this,n,t)},n.setAttributeArray=function(e,t,n,r,i){var s=this.attributeIndex(e);t.bind(),this._owner.setAttributeArray(this,s,n,r,i)},n.setUniformVector=function(e,t){var n=this.uniformIndex(e);this._owner.setUniformVector(this,n,t)},n.setUniformMatrix=function(e,t){var n=this.uniformIndex(e);this._owner.setUniformMatrix(this,n,t)},n.setTexture=function(e,t){var n=this.uniformIndex(e),r=this._textureIdMap[e];r||(r=this._textureId++,this._textureIdMap[e]=r),this._owner.setTexture(this,n,r,t)},n.drawArrays=function(e,t,n){this._owner.drawArrays(this,e,t,n)},n.drawElements=function(e,t,n,r){t.bind(),this._owner.drawElements(this,e,n,r)},n},Tma3DScreen.prototype.createBuffer=function(e){var t=this.gl.createBuffer();return t._buffer=e.constructor.name=="Float32Array"?e:new Float32Array(e),t._owner=this,t.bind=function(){this._owner.gl.bindBuffer(this._owner.gl.ARRAY_BUFFER,this)},t.buffer=function(){return this._buffer},t.update=function(){this.bind();var e=this._owner.gl;e.bufferData(e.ARRAY_BUFFER,t._buffer,e.STATIC_DRAW)},t.deleteBuffer=function(){this._owner.gl.deleteBuffer(this),this._buffer=null,this._owner=null},t.update(),t},Tma3DScreen.prototype.createElementBuffer=function(e){var t=this.gl.createBuffer();return this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,t),this.gl.bufferData(this.gl.ELEMENT_ARRAY_BUFFER,new Uint16Array(e),this.gl.STATIC_DRAW),t._owner=this,t.bind=function(){this._owner.gl.bindBuffer(this._owner.gl.ELEMENT_ARRAY_BUFFER,this)},t},Tma3DScreen.prototype.createFrameBuffer=function(e,t){var n=this.gl.createFramebuffer();return n.width=e,n.height=t,n._owner=this,n.texture=null,n.renderbuffer=null,n.bind=function(){var e=this._owner._lastBoundFrameBuffer;if(e==this)return e;this._owner._lastBoundFrameBuffer=this;var t=this._owner.gl;return t.bindFramebuffer(t.FRAMEBUFFER,this),this.texture||(this.texture=t.createTexture(),t.bindTexture(t.TEXTURE_2D,this.texture),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,this.width,this.height,0,t.RGBA,t.UNSIGNED_BYTE,null),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.texture,0)),this.renderbuffer||(this.renderbuffer=t.createRenderbuffer(),t.bindRenderbuffer(t.RENDERBUFFER,this.renderbuffer),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,this.width,this.height),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,this.renderbuffer)),t.viewport(0,0,this.width,this.height),e},n},Tma3DScreen.prototype.createImage=function(e,t,n){var r=this.context.createImageData(e,t);if(n){var i=r.data,s=e*t*4;for(var o=0;o<s;++o)i[o]=n[o]}return r.setPixel=TmaScreen.prototype.setPixel,r.addPixel=TmaScreen.prototype.addPixel,r.drawLine=TmaScreen.prototype.drawLine,r},Tma3DScreen.prototype.convertImage=function(e){this.canvas2d.width=e.width,this.canvas2d.height=e.height,this.context.drawImage(e,0,0);var t=this.context.getImageData(0,0,e.width,e.height);return this.createImage(t.width,t.height,t.data)},Tma3DScreen.prototype.createStringTexture=function(e,t,n){var r=t.size+"px "+t.name;this.context.font=r;var i=this.context.measureText(e).width,s=t.size*devicePixelRatio*1.5;n&&(n.width&&(i=n.width),n.height&&(s=n.height)),this.canvas2d.width=i,this.canvas2d.height=s,this.context.font=r,this.context.fillStyle=t.background,this.context.fillRect(0,0,i,s),this.context.fillStyle=t.foreground,this.context.textAlign="center",this.context.textBaseline="middle",this.context.fillText(e,i/2,s/2);var o=this.context.getImageData(0,0,i,s),u=this.createImage(o.width,o.height,o.data);return this.createTexture(u,!0,Tma3DScreen.FILTER_LINEAR)},Tma3DScreen.prototype.createFloatTexture=function(e,t,n,r){var i=this.gl.createTexture();return i.width=t,i.height=n,i.data=e,this.gl.bindTexture(this.gl.TEXTURE_2D,i),this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,r),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,t,n,0,this.gl.RGBA,this.gl.FLOAT,e),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),i._flip=r,i._owner=this,i.update=function(e){var t=this._owner.gl;t.bindTexture(t.TEXTURE_2D,this),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,this.width,this.height,0,t.RGBA,t.FLOAT,e)},i},Tma3DScreen.prototype.createTexture=function(e,t,n){var r=this.gl.createTexture();return r.width=e.width,r.height=e.height,r.image=e,this.gl.bindTexture(this.gl.TEXTURE_2D,r),this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,t),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,e),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,n),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,n),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),r._flip=t,r._owner=this,r.update=function(e){var t=this._owner.gl;t.bindTexture(t.TEXTURE_2D,this),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e)},r},Tma3DScreen.prototype.bind=function(){var e=this._lastBoundFrameBuffer;return this._lastBoundFrameBuffer=this,this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),this.gl.viewport(0,0,this.width,this.height),e},Tma3DScreen.prototype.setAttribute=function(e,t,n){this.gl.useProgram(e),1==n.length?this.gl.vertexAttrib1fv(t,n):2==n.length?this.gl.vertexAttrib2fv(t,n):3==n.length?this.gl.vertexAttrib3fv(t,n):4==n.length&&this.gl.vertexAttrib4fv(t,n),this.gl.disableVertexAttribArray(t)},Tma3DScreen.prototype.setAttributeArray=function(e,t,n,r,i){this.gl.useProgram(e),this.gl.vertexAttribPointer(t,r,this.gl.FLOAT,!1,i,n),this.gl.enableVertexAttribArray(t)},Tma3DScreen.prototype.setUniformVector=function(e,t,n){this.gl.useProgram(e),1==n.length?this.gl.uniform1fv(t,n):2==n.length?this.gl.uniform2fv(t,n):3==n.length?this.gl.uniform3fv(t,n):4==n.length?this.gl.uniform4fv(t,n):tma.error("WebGL unknown uniform vector size: "+n.length)},Tma3DScreen.prototype.setUniformMatrix=function(e,t,n){this.gl.useProgram(e),4==n.length?this.gl.uniformMatrix2fv(t,!1,n):9==n.length?this.gl.uniformMatrix3fv(t,!1,n):16==n.length?this.gl.uniformMatrix4fv(t,!1,n):tma.error("WebGL unknown uniform matrix size: "+n.length)},Tma3DScreen.prototype.setTexture=function(e,t,n,r){this.gl.useProgram(e),this.gl.activeTexture(this.gl.TEXTURE0+n),this.gl.bindTexture(this.gl.TEXTURE_2D,r),this.gl.uniform1i(t,n)},Tma3DScreen.prototype.drawArrays=function(e,t,n,r){this.gl.useProgram(e),this.gl.drawArrays(t,n,r)},Tma3DScreen.prototype.drawElements=function(e,t,n,r){this.gl.useProgram(e),this.gl.drawElements(t,r,this.gl.UNSIGNED_SHORT,n)},Tma3DScreen.prototype.fillColor=function(e,t,n,r){this.gl.clearColor(e,t,n,r),this.gl.clearDepth(1),this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT)},Tma3DScreen.prototype.setAlphaMode=function(e,t,n){this._currentAlphaMode={on:e,src:t,dst:n},e?(this.gl.disable(this.gl.DEPTH_TEST),this.gl.enable(this.gl.BLEND),this.gl.blendFunc(t,n)):(this.gl.disable(this.gl.BLEND),this.gl.enable(this.gl.DEPTH_TEST),this.gl.depthFunc(this.gl.LEQUAL))},Tma3DScreen.prototype.pushAlphaMode=function(){this._alphaModeStack.push(this._currentAlphaMode)},Tma3DScreen.prototype.popAlphaMode=function(){var e=this._alphaModeStack.pop();this.setAlphaMode(e.on,e.src,e.dst)},Tma3DScreen.prototype.setCullingMode=function(e,t){this._currentCullingMode={on:e,ccw:t},e?(this.gl.enable(this.gl.CULL_FACE),this.gl.frontFace(t?this.gl.CCW:this.gl.CW)):this.gl.disable(this.gl.CULL_FACE)},Tma3DScreen.prototype.pushCullingMode=function(){this._cullingModeStack.push(this._currentCullingMode)},Tma3DScreen.prototype.popCullingMode=function(){var e=this._cullingModeStack.pop();this.setCullingMode(e.on,e.ccw)},Tma3DScreen.prototype.setLineWidth=function(e){this.gl.lineWidth(e)},Tma3DScreen.prototype.flush=function(){this.gl.flush()},Tma3DScreen.prototype.mouse=function(){return this._mouse?{over:this._mouse,x:this._mouseX,y:this._mouseY,click:{on:this._mousePressed,x:this._mouseClickX,y:this._mouseClickY},width:this._mouseWidth,height:this._mouseHeight}:{over:!1,x:0,y:0,click:{on:!1,x:0,y:0},width:0,height:0}},Tma3DScreen.prototype._onmousemove=function(e){this._mouse=!0;var t=e.target.getBoundingClientRect();this._mouseX=e.clientX-t.left,this._mouseY=e.clientY-t.top,this._mouseWidth=t.right-t.left,this._mouseHeight=t.bottom-t.top,this._mousePressed&&this.onMouseDrag(this._mouseX,this._mouseY)},Tma3DScreen.prototype._onmouseout=function(e){this._mouse=!1},Tma3DScreen.prototype._onmousedown=function(e){var t=e.target.getBoundingClientRect();this._mouseX=e.clientX-t.left,this._mouseY=e.clientY-t.top,this._mousePressed=!0,this._mouseClickX=this._mouseX,this._mouseClickY=this._mouseY,this.onMouseDown(this._mouseX,this._mouseY),this.onMouseDrag(this._mouseX,this._mouseY)},Tma3DScreen.prototype._onmouseup=function(e){var t=e.target.getBoundingClientRect();this._mouseX=e.clientX-t.left,this._mouseY=e.clientY-t.top,this._mousePressed=!1,this.onMouseDrag(this._mouseX,this._mouseY),this.onMouseUp(this._mouseX,this._mouseY)},Tma3DScreen.prototype.onMouseDown=function(e,t){},Tma3DScreen.prototype.onMouseDrag=function(e,t){},Tma3DScreen.prototype.onMouseUp=function(e,t){},exports.Tma3DScreen=Tma3DScreen,TmaModelPrimitives.prototype.scale=function(e){for(var t=0;t<this._vertices.length;++t)this._vertices[t]*=e},TmaModelPrimitives.prototype.items=function(){return this._indices.length},TmaModelPrimitives.prototype.getVertices=function(){return this._vertices},TmaModelPrimitives.prototype.getCoords=function(){return this._coords},TmaModelPrimitives.prototype.getIndices=function(){return this._indices},TmaModelPrimitives.prototype.getColors=function(){return this._colors},TmaModelPrimitives.prototype.getVerticesBuffer=function(e){return this._verticesBuffer||(this._verticesBuffer=e.createBuffer(this.getVertices())),this._verticesBuffer},TmaModelPrimitives.prototype.getCoordsBuffer=function(e){return this._coordsBuffer||(this._coordsBuffer=e.createBuffer(this.getCoords())),this._coordsBuffer},TmaModelPrimitives.prototype.getIndicesBuffer=function(e){return this._indicesBuffer||(this._indicesBuffer=e.createElementBuffer(this.getIndices())),this._indicesBuffer},TmaModelPrimitives.prototype.getColorsBuffer=function(e){return this._colorsBuffer||(this._colorsBuffer=e.createBuffer(this.getColors())),this._colorsBuffer},TmaModelPrimitives.prototype.setTexture=function(e){this._texture=e},TmaModelPrimitives.prototype.getTexture=function(){return this._texture},TmaModelPrimitives.prototype.setDrawMode=function(e){this._mode=e},TmaModelPrimitives.prototype.getDrawMode=function(){return this._mode},TmaModelPrimitives.prototype._createBox=function(){this._vertices=[-0.5,-0.5,0,.5,-0.5,0,.5,.5,0,-0.5,.5,0],this._indices=[0,1,2,2,3,0],this._coords=[0,0,1,0,1,1,0,1]},TmaModelPrimitives.prototype._createCube=function(){this._vertices=[-0.5,-0.5,-0.5,-0.5,-0.5,.5,-0.5,.5,-0.5,-0.5,.5,.5,.5,-0.5,-0.5,.5,-0.5,.5,.5,.5,-0.5,.5,.5,.5],this._indices=[1,5,7,7,3,1,3,7,6,6,2,3,2,6,4,4,0,2,0,4,5,5,1,0,4,6,7,7,5,4,0,1,3,3,2,0],this._coords=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]},TmaModelPrimitives.prototype._createPoints=function(e){this._vertices=e;var t=e.length/3;this._indices=new Array(t),this._colors=new Array(t*4),this._coords=null;for(var n=0;n<t;++n)this._indices[n]=n,this._colors[n*4+0]=1,this._colors[n*4+1]=1,this._colors[n*4+2]=1,this._colors[n*4+3]=1;this._mode=Tma3DScreen.MODE_POINTS},TmaModelPrimitives.prototype._createSphereEven=function(e){var t=[[1,0,0],[0,1,0],[-1,0,0],[0,-1,0]],n=function(e,t){var n=this._vertices.length/3,r=Math.sqrt(e[0]*e[0]+e[1]*e[1]),i=.5;r!=0&&(i=Math.acos(e[0]/r)/Math.PI/2),e[1]<0&&(i=1-i),i==0&&!t&&(i=1);var s=1-Math.acos(e[2])/Math.PI;for(var o=0;o<n;++o){if(this._vertices[o*3+0]!=e[0]||this._vertices[o*3+1]!=e[1]||this._vertices[o*3+2]!=e[2]||this._coords[o*2+0]!=i||this._coords[o*2+1]!=s)continue;this._indices.push(o);return}this._indices.push(o),this._vertices=this._vertices.concat(e),this._coords.push(i),this._coords.push(s)}.bind(this),i=function(e,t,r){var i=(e[1]+t[1]+r[1])/3>0;n(e,i),n(t,i),n(r,i)}.bind(this),s=function(e,t,n,o){if(e==0){i(t,n,o);return}e--;var u=function(e,t){var n=(e[0]+t[0])/2,i=(e[1]+t[1])/2,s=(e[2]+t[2])/2;return r=Math.sqrt(n*n+i*i+s*s),[n/r,i/r,s/r]},a=u(t,n),f=u(n,o),l=u(o,t);s(e,t,a,l),s(e,a,n,f),s(e,f,o,l),s(e,a,f,l)};for(var o=0;o<t.length;++o){var u=(o+1)%t.length;s(e,t[o],t[u],[0,0,1]),s(e,t[o],t[u],[0,0,-1])}},TmaModelPrimitives.SPHERE_METHOD_THEODOLITE=0,TmaModelPrimitives.SPHERE_METHOD_EVEN=1,TmaModelPrimitives.createBox=function(){var e=new TmaModelPrimitives;return e._createBox(),e},TmaModelPrimitives.createCube=function(){var e=new TmaModelPrimitives;return e._createCube(),e},TmaModelPrimitives.createPoints=function(e){var t=new TmaModelPrimitives;return t._createPoints(e),t},TmaModelPrimitives.createSphere=function(e,t){var n=new TmaModelPrimitives;return n._createSphereEven(e),n},exports.TmaModelPrimitives=TmaModelPrimitives,TmaParticle.prototype.initialize=function(){},TmaParticle.prototype.update=function(){return!1},TmaParticle.prototype.remove=function(){this._container.remove(this._offset)},TmaParticle.Container=function(e){this.length=0,this._func=e,this._particles=[]},TmaParticle.Container.prototype.at=function(e){return this._particles[e]},TmaParticle.Container.prototype.add=function(){this._particles.length==this.length&&(this._particles[this.length]=new this._func(this,this.length)),this._particles[this.length].initialize.apply(this._particles[this.length++],arguments)},TmaParticle.Container.prototype.remove=function(e){var t=this._particles[e];t._offset=--this.length,this._particles[e]=this._particles[this.length],this._particles[e]._offset=e,this._particles[this.length]=t},TmaParticle.Container.prototype.update=function(){for(var e=0;e<this.length;)this._particles[e].update.apply(this._particles[e],arguments)?e++:this.remove(e)},exports.TmaParticle=TmaParticle,TmaSequencer.prototype.start=function(e){this.stop(),this._elapsed=0},TmaSequencer.prototype.stop=function(){for(var e=0;e<this._active.length;++e)this._active[e].task.stop();this._queue=this._finished.concat(this._active,this._queue),this._active=[],this._finished=[]},TmaSequencer.prototype.run=function(e){this._elapsed+=e;var t=[];for(var n=0;n<this._active.length;++n){var r=this._active[n].task.run(e,this._elapsed);r==0?t.push(this._active[n]):(this._active[n].task.stop(),this._finished.push(this._active[n]))}this._active=t;while(this._queue.length>0&&this._queue[0].when<this._elapsed){var i=this._queue.shift();i.task.start();var r=i.task.run(this._elapsed-i.when,this._elapsed);r==0?t.push(i):(i.task.stop(),this._finished.push(i))}},TmaSequencer.prototype.register=function(e,t){var n={when:e,task:t};for(var r=0;r<this._queue.length;++r){if(this._queue[r].when<=e)continue;r==0?this._queue=this._unshift(n):this._queue=this._queue.slice(0,r).concat([n],this._queue.slice(r,this._queue.length));return}this._queue.push(n)},TmaSequencer.prototype.elapsed=function(){return this._elapsed},TmaSequencer.prototype.active=function(){return this._active.length!=0||this._queue.length!=0},TmaSequencer.Task=function(e,t){this.reset(e),this._callback=t},TmaSequencer.Task.INFINITE=-1,TmaSequencer.Task.prototype.reset=function(e){this._duration=e,this._elapsed=0},TmaSequencer.Task.prototype.start=function(){this.stop(),this._elapsed=0},TmaSequencer.Task.prototype.stop=function(){},TmaSequencer.Task.prototype.atEnd=function(){return this._duration!=TmaSequencer.Task.INFINITE&&this._elapsed>=this._duration},TmaSequencer.Task.prototype.spend=function(e){return this._elapsed+=e,this._duration==TmaSequencer.Task.INFINITE?0:this._elapsed<=this._duration?0:this._elapsed-this._duration},TmaSequencer.Task.prototype.run=function(e,t){return this._callback&&this._callback(e,t),this.spend(e)},TmaSequencer.Task.prototype.duration=function(){return this._duration},TmaSequencer.SerialTask=function(){this.superclass(0),this._queue=[],this._active=null,this._finished=[],this._start=0},TmaSequencer.SerialTask.prototype=new TmaSequencer.Task,TmaSequencer.SerialTask.prototype.superclass=TmaSequencer.Task,TmaSequencer.SerialTask.prototype.constructor=TmaSequencer.SerialTask,TmaSequencer.SerialTask.prototype.append=function(e){var t=e.duration();t==TmaSequencer.Task.INFINITE?this._duration=TmaSequencer.Task.INFINITE:this._duration+=t,this._queue.push(e)},TmaSequencer.SerialTask.prototype.start=function(){this.stop(),this._elapsed=0,this._timeBase=-1,this._active=this._queue.shift(),this._active.start()},TmaSequencer.SerialTask.prototype.stop=function(){this._active&&(this._active.stop(),this._finished.push(this._active),this._active=null),this._queue=this._finished.concat(this._queue),this._finished=[]},TmaSequencer.SerialTask.prototype.run=function(e,t){this._timeBase<0&&(this._timeBase=t-e);var n=e,r=t-this._timeBase;while(this._active){var i=this._active.run(n,r);if(i==0)return this.spend(n);var s=n-i;n=i,this._active.stop(),this._finished.push(this._active),this._active=this._queue.shift(),this._active&&this._active.start()}return this.spend(e)},TmaSequencer.ParallelTask=function(){this.superclass(0),this._active=[],this._finished=[],this._timeBase=-1},TmaSequencer.ParallelTask.prototype=new TmaSequencer.Task,TmaSequencer.ParallelTask.prototype.superclass=TmaSequencer.Task,TmaSequencer.ParallelTask.prototype.constructor=TmaSequencer.ParallelTask,TmaSequencer.ParallelTask.prototype.append=function(e){var t=e.duration();t==TmaSequencer.Task.INFINITE?this._duration=TmaSequencer.Task.INFINITE:this._duration!=TmaSequencer.Task.INFINITE&&(this._duration=Math.max(this._duration,t)),this._active.push(e)},TmaSequencer.ParallelTask.prototype.start=function(){this.stop
(),this._elapsed=0,this._timeBase=-1;for(var e=0;e<this._active.length;++e)this._active[e].start()},TmaSequencer.ParallelTask.prototype.stop=function(){for(var e=0;e<this._active.length;++e)this._active[e].stop(),this._finished.push(this._active[e]);this._active=this._finished,this._finished=[]},TmaSequencer.ParallelTask.prototype.run=function(e,t){this._timeBase<0&&(this._timeBase=t-e);var n=[],r=t-this._timeBase;for(var i=0;i<this._active.length;++i){var s=this._active[i].run(e,r);this._active[i].atEnd()?(this._active[i].stop(),this._finished.push(this._active[i])):n.push(this._active[i])}return this._active=n,this.spend(e)},TmaSequencer.RepeatTask=function(e,t){var n=TmaSequencer.Task.INFINITE;typeof t=="undefined"&&(t=TmaSequencer.RepeatTask.INFINITE),t!=TmaSequencer.RepeatTask.INFINITE&&(n=e.duration()*t),this.superclass(n),this._task=e,this._iteration=t,this._count=0,this._timeBase=-1},TmaSequencer.RepeatTask.INFINITE=-1,TmaSequencer.RepeatTask.prototype=new TmaSequencer.Task,TmaSequencer.RepeatTask.prototype.superclass=TmaSequencer.Task,TmaSequencer.RepeatTask.prototype.constructor=TmaSequencer.RepeatTask,TmaSequencer.RepeatTask.prototype.start=function(){this.stop(),this._elapsed=0,this._timeBase=-1,this._count=0,this._task.start()},TmaSequencer.RepeatTask.prototype.stop=function(){this._task.stop()},TmaSequencer.RepeatTask.prototype.run=function(e,t){if(this._count==this._iteration)return e;this._timeBase<0&&(this._timeBase=t-e);var n=t-this._timeBase,r=e;while(r>0){var i=this._task.run(r,n);this.spend(r-i);if(this._task.atEnd()){this._task.stop(),this._count++;if(this._count==this._iteration)return i;this._task.start()}r=i}return 0},TmaMotionBvh._CODE_A="A".charCodeAt(0),TmaMotionBvh._CODE_Z="Z".charCodeAt(0),TmaMotionBvh._CODE_a="a".charCodeAt(0),TmaMotionBvh._CODE_z="z".charCodeAt(0),TmaMotionBvh._CODE_0="0".charCodeAt(0),TmaMotionBvh._CODE_9="9".charCodeAt(0),TmaMotionBvh._CODE_DOT=".".charCodeAt(0),TmaMotionBvh._CODE_MINUS="-".charCodeAt(0),TmaMotionBvh._CASE_CHANNELS="C".charCodeAt(0),TmaMotionBvh._CASE_ENDSITE="E".charCodeAt(0),TmaMotionBvh._CASE_FRAME="F".charCodeAt(0),TmaMotionBvh._CASE_HIERARCHY="H".charCodeAt(0),TmaMotionBvh._CASE_JOINT="J".charCodeAt(0),TmaMotionBvh._CASE_MOTION="M".charCodeAt(0),TmaMotionBvh._CASE_OFFSET="O".charCodeAt(0),TmaMotionBvh._CASE_ROOT="R".charCodeAt(0),TmaMotionBvh._CASE_X="X".charCodeAt(0),TmaMotionBvh._CASE_Y="Y".charCodeAt(0),TmaMotionBvh._CASE_Z="Z".charCodeAt(0),TmaMotionBvh._CASE_POSITION="p".charCodeAt(0),TmaMotionBvh._CASE_ROTATION="r".charCodeAt(0),TmaMotionBvh._CASE_BEGIN="{".charCodeAt(0),TmaMotionBvh._CASE_END="}".charCodeAt(0),TmaMotionBvh._CASE_SP=" ".charCodeAt(0),TmaMotionBvh._CASE_CR="\r".charCodeAt(0),TmaMotionBvh._CASE_LF="\n".charCodeAt(0),TmaMotionBvh._KEY_CHANNELS="CHANNELS",TmaMotionBvh._KEY_ENDSITE="End Site",TmaMotionBvh._KEY_HIERARCHY="HIERARCHY",TmaMotionBvh._KEY_JOINT="JOINT",TmaMotionBvh._KEY_MOTION="MOTION",TmaMotionBvh._KEY_OFFSET="OFFSET",TmaMotionBvh._KEY_ROOT="ROOT",TmaMotionBvh._KEY_POSITION="position",TmaMotionBvh._KEY_ROTATION="rotation",TmaMotionBvh._KEY_FRAMES="Frames: ",TmaMotionBvh._KEY_FRAME_TIME="Frame Time: ",TmaMotionBvh._ID_UNKNOWN=-2,TmaMotionBvh._ID_EOF=-1,TmaMotionBvh._ID_CHANNELS=1,TmaMotionBvh._ID_ENDSITE=2,TmaMotionBvh._ID_HIERARCHY=3,TmaMotionBvh._ID_JOINT=4,TmaMotionBvh._ID_MOTION=5,TmaMotionBvh._ID_OFFSET=6,TmaMotionBvh._ID_ROOT=7,TmaMotionBvh._ID_XPOSITION=8,TmaMotionBvh._ID_YPOSITION=9,TmaMotionBvh._ID_ZPOSITION=10,TmaMotionBvh._ID_XROTATION=11,TmaMotionBvh._ID_YROTATION=12,TmaMotionBvh._ID_ZROTATION=13,TmaMotionBvh._ID_BEGIN=14,TmaMotionBvh._ID_END=15,TmaMotionBvh._ID_NAME=16,TmaMotionBvh._ID_NUMBER=17,TmaMotionBvh._ID_FRAMES=18,TmaMotionBvh._ID_FRAME_TIME=19,TmaMotionBvh._isNumber=function(e){return TmaMotionBvh._CODE_0<=e&&e<=TmaMotionBvh._CODE_9?!0:!1},TmaMotionBvh._isAlphabet=function(e){return TmaMotionBvh._CODE_A<=e&&e<=TmaMotionBvh._CODE_Z?!0:TmaMotionBvh._CODE_a<=e&&e<=TmaMotionBvh._CODE_z?!0:!1},TmaMotionBvh._checkKey=function(e,t){var n=t.length;if(e.offset+n>e.byteLength)return!1;for(var r=0;r<n;r++)if(e.data[e.offset+r]!=t.charCodeAt(r))return!1;return e.offset+=n,!0},TmaMotionBvh._parseJoint=function(e,t,n){var r=TmaMotionBvh._parse(e);if(TmaMotionBvh._ID_BEGIN!=r.id)return tma.error("BVH: JOINT/End Site doesn't start with '{'"),!1;t.site=n,t.joint=[],t.totalChannels=0;for(;;){r=TmaMotionBvh._parse(e);switch(r.id){case TmaMotionBvh._ID_CHANNELS:if(n)return tma.error("BVH: End Site can not have a CHANNELS"),!1;r=TmaMotionBvh._parse(e);if(TmaMotionBvh._ID_NUMBER!=r.id)return tma.error("BVH: CHANNELS requires a number"),!1;var i=r.value;t.channels={Xposition:!1,Yposition:!1,Zposition:!1,Xrotation:!1,Yrotation:!1,Zrotation:!1};for(var s=0;s<i;s++){r=TmaMotionBvh._parse(e);switch(r.id){case TmaMotionBvh._ID_XPOSITION:t.channels.Xposition=!0;break;case TmaMotionBvh._ID_YPOSITION:t.channels.Yposition=!0;break;case TmaMotionBvh._ID_ZPOSITION:t.channels.Zposition=!0;break;case TmaMotionBvh._ID_XROTATION:t.channels.Xrotation=!0;break;case TmaMotionBvh._ID_YROTATION:t.channels.Yrotation=!0;break;case TmaMotionBvh._ID_ZROTATION:t.channels.Zrotation=!0;break;default:return tma.error("BVH: CHANNELS has unknown channel keyword"),!1}}t.totalChannels+=i;break;case TmaMotionBvh._ID_END:return!0;case TmaMotionBvh._ID_ENDSITE:var o={name:"End Site"};tma.log("BVH: End Site"),t.joint.push(o);if(!TmaMotionBvh._parseJoint(e,o,!0))return!1;break;case TmaMotionBvh._ID_JOINT:if(n)return tma.error("BVH: End Site can not have a JOINT"),!1;r=TmaMotionBvh._parse(e);if(TmaMotionBvh._ID_NAME!=r.id)return tma.error("BVH: JOINT doesn't have a name"),!1;var u={name:r.value};tma.log("BVH: JOINT "+r.value),t.joint.push(u);if(!TmaMotionBvh._parseJoint(e,u,!1))return!1;t.totalChannels+=u.totalChannels;break;case TmaMotionBvh._ID_OFFSET:r=TmaMotionBvh._parse(e);if(TmaMotionBvh._ID_NUMBER==r.id){var a=r.value;r=TmaMotionBvh._parse(e);if(TmaMotionBvh._ID_NUMBER==r.id){var f=r.value;r=TmaMotionBvh._parse(e);if(TmaMotionBvh._ID_NUMBER==r.id){var l=r.value;t.offset={x:a,y:f,z:l};break}}}return tma.error("BVH: OFFSET requires three numbers"),!1;default:return tma.error("BVH: internal error"),!1}}return!0},TmaMotionBvh._parse=function(e){var t=e.data.byteLength;for(var n={id:TmaMotionBvh._ID_UNKNOWN};e.offset<t;e.offset++){var r=e.data[e.offset],i=[];switch(r){case TmaMotionBvh._CASE_CHANNELS:if(!TmaMotionBvh._checkKey(e,TmaMotionBvh._KEY_CHANNELS))break;return{id:TmaMotionBvh._ID_CHANNELS};case TmaMotionBvh._CASE_ENDSITE:if(!TmaMotionBvh._checkKey(e,TmaMotionBvh._KEY_ENDSITE))break;return{id:TmaMotionBvh._ID_ENDSITE};case TmaMotionBvh._CASE_FRAME:if(TmaMotionBvh._checkKey(e,TmaMotionBvh._KEY_FRAMES))return{id:TmaMotionBvh._ID_FRAMES};if(TmaMotionBvh._checkKey(e,TmaMotionBvh._KEY_FRAME_TIME))return{id:TmaMotionBvh._ID_FRAME_TIME};break;case TmaMotionBvh._CASE_HIERARCHY:if(!TmaMotionBvh._checkKey(e,TmaMotionBvh._KEY_HIERARCHY))break;return{id:TmaMotionBvh._ID_HIERARCHY};case TmaMotionBvh._CASE_JOINT:if(!TmaMotionBvh._checkKey(e,TmaMotionBvh._KEY_JOINT))break;return{id:TmaMotionBvh._ID_JOINT};case TmaMotionBvh._CASE_MOTION:if(!TmaMotionBvh._checkKey(e,TmaMotionBvh._KEY_MOTION))break;return{id:TmaMotionBvh._ID_MOTION};case TmaMotionBvh._CASE_OFFSET:if(!TmaMotionBvh._checkKey(e,TmaMotionBvh._KEY_OFFSET))break;return{id:TmaMotionBvh._ID_OFFSET};case TmaMotionBvh._CASE_ROOT:if(!TmaMotionBvh._checkKey(e,TmaMotionBvh._KEY_ROOT))break;return{id:TmaMotionBvh._ID_ROOT};case TmaMotionBvh._CASE_X:i=[TmaMotionBvh._ID_XPOSITION,TmaMotionBvh._ID_XROTATION];break;case TmaMotionBvh._CASE_Y:i=[TmaMotionBvh._ID_YPOSITION,TmaMotionBvh._ID_YROTATION];break;case TmaMotionBvh._CASE_Z:i=[TmaMotionBvh._ID_ZPOSITION,TmaMotionBvh._ID_ZROTATION];break;case TmaMotionBvh._CASE_BEGIN:return e.offset++,{id:TmaMotionBvh._ID_BEGIN};case TmaMotionBvh._CASE_END:return e.offset++,{id:TmaMotionBvh._ID_END};case TmaMotionBvh._CASE_SP:case TmaMotionBvh._CASE_CR:case TmaMotionBvh._CASE_LF:continue;default:}if(0!=i.length&&e.offset+1<t){var s=e.data[++e.offset];if(TmaMotionBvh._CASE_POSITION==s){if(TmaMotionBvh._checkKey(e,TmaMotionBvh._KEY_POSITION))return{id:i[0]}}else if(TmaMotionBvh._CASE_ROTATION==s&&TmaMotionBvh._checkKey(e,TmaMotionBvh._KEY_ROTATION))return{id:i[1]};e.offset--}var o;if(TmaMotionBvh._isAlphabet(e.data[e.offset])){for(var u=[];e.offset<e.data.byteLength;e.offset++){o=e.data[e.offset];if(!TmaMotionBvh._isAlphabet(o)&&!TmaMotionBvh._isNumber(o))break;u.push(String.fromCharCode(o))}return{id:TmaMotionBvh._ID_NAME,value:u.join("")}}var a=[];TmaMotionBvh._CODE_MINUS==e.data[e.offset]&&(a.push("-"),e.offset++);for(var f=!1;e.offset<e.data.byteLength;e.offset++){o=e.data[e.offset];if(TmaMotionBvh._CODE_DOT==o){if(f)return tma.warn("BVH: dot apears twice for a number"),n;f=!0}else if(!TmaMotionBvh._isNumber(o))break;a.push(String.fromCharCode(o))}return 0==a.length?n:{id:TmaMotionBvh._ID_NUMBER,value:Number(a.join(""))}}return{id:TmaMotionBvh._ID_EOF}},TmaMotionBvh.prototype.load=function(e){var t={data:new Uint8Array(e),offset:0},n=TmaMotionBvh._parse(t);if(TmaMotionBvh._ID_HIERARCHY!=n.id)return tma.error("BVH: HIERARCHY not found"),!1;n=TmaMotionBvh._parse(t);if(TmaMotionBvh._ID_ROOT!=n.id)return tma.error("BVH: ROOT not found"),!1;n=TmaMotionBvh._parse(t);if(TmaMotionBvh._ID_NAME!=n.id)return tma.error("BVH: ROOT doesn't have a name"),!1;tma.log("BVH: ROOT "+n.value);var r={name:n.value};if(!TmaMotionBvh._parseJoint(t,r,!1))return!1;n=TmaMotionBvh._parse(t);if(TmaMotionBvh._ID_MOTION!=n.id)return tma.error("BVH: MOTION not found"),!1;n=TmaMotionBvh._parse(t);if(TmaMotionBvh._ID_FRAMES!=n.id)return tma.error("BVH: Frames not found"),!1;n=TmaMotionBvh._parse(t);if(TmaMotionBvh._ID_NUMBER!=n.id)return tma.error("BVH: Frames doesn't have a number"),!1;tma.log("BVH: Frames "+n.value),this.frameLength=n.value,n=TmaMotionBvh._parse(t);if(TmaMotionBvh._ID_FRAME_TIME!=n.id)return tma.error("BVH: Frame Time not found"),!1;n=TmaMotionBvh._parse(t);if(TmaMotionBvh._ID_NUMBER!=n.id)return tma.error("BVH: Frame Time doesn't have a number"),!1;tma.log("BVH: Frame Time "+n.value),this.frameTime=n.value,tma.log("BVH: Total Channels "+r.totalChannels),this._frameData=[];for(var i=0;i<this.frameLength;i++){var e=[];for(var s=0;s<r.totalChannels;s++){n=TmaMotionBvh._parse(t);if(TmaMotionBvh._ID_NUMBER!=n.id)return tma.error("BVH: data broken at frame "+i),!1;e.push(n.value)}this._frameData.push(e)}return tma.log("BVH: done"),n=TmaMotionBvh._parse(t),TmaMotionBvh._ID_EOF!=n.id&&tma.warn("BVH: unused data exists"),this._root=r,!0},TmaMotionBvh.prototype.getFrameAt=function(e){return this._frameData[e]},exports.TmaMotionBvh=TmaMotionBvh,TmaModelPly.prototype.load=function(e){var t=new function(e){typeof e=="string"?(this._data=e,this._cr="\r",this._lf="\n",this._sp=" ",this._conv=function(e){return e}):(this._data=new Uint8Array(e),this._cr=13,this._lf=10,this._sp=32,this._conv=function(e){return String.fromCharCode(e)}),this._offset=0,this.readNextLine=function(){var e=[],t=this._offset;for(;t<this._data.length;++t){if(this._data[t]==this._cr||this._data[t]==this._lf)break;(e[e.length-1]!=" "||this._data[t]!=this._sp)&&e.push(this._conv(this._data[t]))}if(e.length==0&&t==this._data.length)return null;this._data[t]==this._cr&&t+1<this._data.length&&this._data[t+1]==this._lf&&++t,t!=this._data.length&&t++,this._offset=t;while(e.length>0&&e[e.length-1]==" ")e.pop();return e.join("")},this.next=function(){var e=this.readNextLine();return e?e.split(" "):null}}(e),n;do n=t.readNextLine();while(n!==null&&n.length==0);if(n===null||n!="ply")return tma.error("ply: can not find magic word 'ply'"),!1;var r=!1,s=!1,o={},u=null;while(!s){var a=t.next();switch(a[0]){case"comment":a.shift(),tma.info("ply: header comment: "+a.join(" "));break;case"element":if(a.length!=3)return tma.error("ply: format error: "+a.join(" ")),!1;o[a[1]]=u={},u.count=parseInt(a[2]),u.keys=0,u.key={},u.data=[];break;case"end_header":s=!0;break;case"format":if(a.length!=3||a[1]!="ascii"||a[2]!="1.0")return tma.error("ply: unknown "+a.join(" ")),!1;r=!0;break;case"property":if(!u)return tma.error("ply: property should follow element: "+a.join(" ")),!1;if(a.length!=3&&a[1]!="list")return tma.error("ply: format error: "+a.join(" ")),!1;a[1]=="list"?u.key[a[a.length-1]]={index:u.keys++,type:a[1]}:a[1]=="float"||a[1]=="float32"||a[1]=="int"||a[1]=="uchar"?u.key[a[2]]={index:u.keys++,type:a[1]}:tma.error("ply: type "+a[1]+" is not supported");break;default:return tma.error("ply: unknown header: "+a.join(" ")),!1}}if(!r)return tma.error("ply: format is not specified"),!1;if(!o.vertex||!o.vertex.key.x||!o.vertex.key.y||!o.vertex.key.z)return tma.error("ply: vertex element with x, y, and z is not found"),!1;for(var f=0;f<o.vertex.count;f++){var l=t.next();if(l.length!=o.vertex.keys)return tma.error("ply: vertex element doesn't contain enough properties"),!1;var c=[];for(i=0;i<l.length;++i)c.push(parseFloat(l[i]));o.vertex.data.push(c)}if(!o.face)return tma.error("ply: face element is not found"),!1;for(var h=0;h<o.face.count;h++){var p=t.next();if(p.length!=parseInt(p[0])+1)return tma.error("ply: face element doesn't contain enough properties"),!1;var d=[];for(i=0;i<p.length;++i)d.push(parseInt(p[i]));o.face.data.push(d)}for(i=0;i<o.vertex.count;++i)this._vertices.push(o.vertex.data[i][o.vertex.key.x.index]),this._vertices.push(o.vertex.data[i][o.vertex.key.y.index]),this._vertices.push(o.vertex.data[i][o.vertex.key.z.index]);for(i=0;i<o.face.count;++i)o.face.data[i].length==4?(this._indices.push(o.face.data[i][1]),this._indices.push(o.face.data[i][2]),this._indices.push(o.face.data[i][3])):(this._indices.push(o.face.data[i][1]),this._indices.push(o.face.data[i][2]),this._indices.push(o.face.data[i][3]),this._indices.push(o.face.data[i][3]),this._indices.push(o.face.data[i][4]),this._indices.push(o.face.data[i][1]));return!0},TmaModelPly.prototype.scale=function(e){for(var t=0;t<this._vertices.length;++t)this._vertices[t]*=e},TmaModelPly.prototype.getVertices=function(){return this._vertices},TmaModelPly.prototype.getCoords=function(){return this._coord},TmaModelPly.prototype.getIndices=function(){return this._indices},exports.TmaModelPly=TmaModelPly,TmaModelPs2Ico._OFFSET_VERSION=0,TmaModelPs2Ico._OFFSET_NBSP=4,TmaModelPs2Ico._OFFSET_ATTRIB=8,TmaModelPs2Ico._OFFSET_BFACE=12,TmaModelPs2Ico._OFFSET_NBVTX=16,TmaModelPs2Ico._OFFSET_VTX=20,TmaModelPs2Ico._ATTRIB_IIP=1,TmaModelPs2Ico._ATTRIB_ANTI=2,TmaModelPs2Ico._ATTRIB_TEX=4,TmaModelPs2Ico._ATTRIB_RLE=8,TmaModelPs2Ico.prototype.load=function(e){var t=new DataView(e),n=t.getUint32(TmaModelPs2Ico._OFFSET_VERSION,!0);if(n!=65536)return tma.error("PS2ICO: Unknown version format"),!1;tma.info("PS2ICO: version 1.00");var r=t.getUint32(TmaModelPs2Ico._OFFSET_NBSP,!0);this.shapes=r,tma.info("PS2ICO: shapes "+r);var i=t.getUint32(TmaModelPs2Ico._OFFSET_ATTRIB,!0);tma.info("PS2ICO: attributes "+i.toString(16));if(i&TmaModelPs2Ico._ATTRIB_RLE)return tma.error("PS2ICO: run-length encoding texture is not supported"),!1;var s=t.getFloat32(TmaModelPs2Ico._OFFSET_BFACE,!0);tma.info("PS2ICO: back face clip "+s);var o=t.getUint32(TmaModelPs2Ico._OFFSET_NBVTX,!0);tma.info("PS2ICO: vertices "+o);var u=TmaModelPs2Ico._OFFSET_VTX;this._vertices=new Array(r);for(var a=0;a<r;++a)this._vertices[a]=new Array(o*3);this._coord=new Array(o*2);for(var f=0;f<o;++f){for(a=0;a<r;++a){var l=t.getInt16(u+0,!0)/1024,c=-t.getInt16(u+2,!0)/1024,h=-t.getInt16(u+4,!0)/1024;this._vertices[a][f*3+0]=l,this._vertices[a][f*3+1]=c,this._vertices[a][f*3+2]=h,u+=8}var p=t.getInt16(u+0,!0)/4096,d=t.getInt16(u+2,!0)/4096,v=t.getInt16(u+4,!0)/4096;u+=8;var m=t.getInt16(u+0,!0)/4096,g=t.getInt16(u+2,!0)/4096;this._coord[f*2+0]=m,this._coord[f*2+1]=1-g,u+=4;var y=t.getUint32(u,!1);u+=4}tma.info("PS2ICO: animation data start at 0x"+u.toString(16));var b=t.getUint32(u,!0);tma.info("PS2ICO: sequences "+b);if(b!=1)return tma.error("PS2ICO: nbseq must be 1"),!1;u+=4;var w=t.getUint32(u+0,!0),E=t.getFloat32(u+4,!0),S=t.getUint32(u+8,!0),x=t.getUint32(u+12,!0);tma.info("PS2ICO: frames "+w),tma.info("PS2ICO: speed "+E),tma.info("PS2ICO: offset "+S),tma.info("PS2ICO: nbksp "+x),this.frames=w,this._weights=new Array(w);for(f=0;f<w;++f)this._weights[f]=new Array(x);u+=16;for(f=0;f<x;++f){var T=t.getUint32(u+0,!0),N=t.getUint32(u+4,!0);u+=8,tma.info("PS2ICO: animation "+T);var C=0,k=0;for(var L=0;L<N;++L){var A=t.getFloat32(u+0,!0),O=t.getFloat32(u+4,!0),M=A-C;if(M==0)C=A,k=O;else{var _=O-k,D=_/M;for(var P=C;P<A;++P)this._weights[P][f]=k,k+=D;C=P,k=O}tma.info("PS2ICO: > "+A+","+O),u+=8}for(;C<60;++C)this._weights[C][f]=k}if(e.byteLength-u!=32768)return tma.error("PS2ICO: texture data size is wrong"),!1;this._texture=new Array(65536);for(f=0;f<this._texture.length;f+=4){var H=t.getUint16(u,!0);u+=2,this._texture[f+0]=(H>>0&31)<<3,this._texture[f+1]=(H>>5&31)<<3,this._texture[f+2]=(H>>10&31)<<3,this._texture[f+3]=255}return!0},TmaModelPs2Ico.prototype.scale=function(e){for(var t=0;t<this.shapes;++t){var n=this._vertices[t];for(var r=0;r<n.length;++r)n[r]*=e}},TmaModelPs2Ico.prototype.getVertices=function(e){return this._vertices[e]},TmaModelPs2Ico.prototype.getCoords=function(){return this._coord},TmaModelPs2Ico.prototype.getTexture=function(){return this._texture},TmaModelPs2Ico.prototype.getWeights=function(e){return this._weights[e]},exports.TmaModelPs2Ico=TmaModelPs2Ico;