Polymer("tma-core",{ready:function(){function o(e,t,n){return e==o.FULL_WIDTH&&(e=Math.max(document.body.clientWidth,document.body.scrollWidth,document.documentElement.scrollWidth,document.documentElement.clientWidth)),t==o.FULL_HEIGHT&&(t=Math.max(document.body.clientHeight,document.body.scrollHeight,document.documentElement.scrollHeight,document.documentElement.clientHeight)),!n||o.MODE_2D==n?new u(e,t):new a(e,t)}function u(e,t){this.width=e,this.height=t,this.canvas=document.createElement("canvas"),this.canvas.width=e,this.canvas.height=t,this.canvas.onmousemove=this._onmousemove.bind(this),this.canvas.onmouseout=this._onmouseout.bind(this),this.canvas.onmousedown=this._onmousedown.bind(this),this.canvas.onmouseup=this._onmouseup.bind(this),this.context=this.canvas.getContext("2d"),this._image=this.context.getImageData(0,0,this.width,this.height),this.data=this._image.data,this._offscreenCanvas=document.createElement("canvas"),this._offscreenCanvas.width=e,this._offscreenCanvas.height=t,this._offscreenContext=this._offscreenCanvas.getContext("2d"),this._offscreenImage=this.createImageData(e,t),this._afterimage=0,this._blurCanvas=document.createElement("canvas"),this._blurCanvas.width=e,this._blurCanvas.height=t,this._blurContext=this._blurCanvas.getContext("2d"),this._blurRatio=0,this._blurAlpha=0,this._blurWidth=0,this._blurHeight=0,this._blurSource={x:0,y:0,w:0,h:0},this._blurDestination={x:0,y:0,w:0,h:0},this._blurSync=!0,this._mouse=!1,this._mouseX=0,this._mouseY=0,this._mousePressed=!1}function a(e,t){this.width=e,this.height=t,this.canvas=document.createElement("canvas"),this.canvas.width=e,this.canvas.height=t,this.canvas.style.backgroundColor="#000000",this.canvas.onmousemove=this._onmousemove.bind(this),this.canvas.onmouseout=this._onmouseout.bind(this),this.canvas.onmousedown=this._onmousedown.bind(this),this.canvas.onmouseup=this._onmouseup.bind(this),this.canvas2d=document.createElement("canvas"),this.context=this.canvas2d.getContext("2d"),this.gl=this.canvas.getContext("webgl",{preserveDrawingBuffer:!0}),this.gl||(s.log("WebGL: webgl is not supported. Try experimental-webgl..."),this.gl=this.canvas.getContext("experimental-webgl")),this.gl||(s.log("WebGL: Try webkit-3d..."),this.gl=this.canvas.getContext("webkit-3d")),this.gl||s.error("WebGL: not supported."),this.gl.getExtension("OES_texture_float")==null&&s.log("WebGL: float texture is not supported."),this.gl.viewport(0,0,e,t),this.setAlphaMode(!1),this.setCullingMode(!1,!0),this._currentAlphaMode={},this._currentCullingMode={},this._alphaModeStack=[],this._cullingModeStack=[],this._lastBoundFrameBuffer=this,this._mouse=!1,this._mouseX=0,this._mouseY=0,this._mouseClickX=0,this._mouseClickY=0,this._mouseWidth=0,this._mouseHeight=0,s.log("WebGL max vertex uniform vectors: "+this.gl.getParameter(this.gl.MAX_VERTEX_UNIFORM_VECTORS)),s.log("WebGL max varying vectors: "+this.gl.getParameter(this.gl.MAX_VARYING_VECTORS)),s.log("WebGL max fragment uniform vectors: "+this.gl.getParameter(this.gl.MAX_FRAGMENT_UNIFORM_VECTORS)),s.log("WebGL max vertex attributes: "+this.gl.getParameter(this.gl.MAX_VERTEX_ATTRIBS)),a._MODE_INITIALIZED||(a.MODE_POINTS=this.gl.POINTS,a.MODE_LINES=this.gl.LINES,a.MODE_LINE_LOOP=this.gl.LINE_LOOP,a.MODE_LINE_STRIP=this.gl.LINE_STRIP,a.MODE_TRIANGLES=this.gl.TRIANGLES,a.MODE_TRIANGLE_STRIP=this.gl.TRIANGLE_STRIP,a.MODE_TRIANGLE_FAN=this.gl.TRIANGLE_FAN,a.FILTER_NEAREST=this.gl.NEAREST,a.FILTER_LINEAR=this.gl.LINEAR,a._MODE_INITIALIZED=!0)}function f(){this._vertices=[],this._coords=[],this._indices=[],this._colors=[],this._verticesBuffer=null,this._coordsBuffer=null,this._indicesBuffer=null,this._colorsBuffer=null,this._texture=null,this._mode=a.MODE_TRIANGLES}function l(e,t){this._container=e,this._offset=t,this.x=0,this.y=0,this.z=0,this.vx=0,this.vy=0,this.vz=0}function c(){this._elapsed=0,this._queue=[],this._active=[],this._finished=[]}function h(){this.frameLength=0,this.frameTime=0,this._frameData=[],this._root=null}function p(){this._vertices=[],this._normals=[],this._coord=[],this._indices=[]}function d(){this.shapes=0,this.frames=0,this._vertices=null,this._coord=null,this._texture=null,this._weights=null}var e={},t={},n={},s={base:"",ready:!0};s.log=console.log.bind(console),s.info=console.info.bind(console),s.warn=console.warn.bind(console),s.error=console.error.bind(console),s.ecb=function(e){console.error(e)},s._libraries={},s._resources={},s.basePath=function(){return s.base},s.load=function(e,t){if(!s._libraries[e]){var n=new Promise(function(n,r){var i=document.createElement("script"),o={callbacks:[n],ready:!1,script:i};t&&o.callbacks.push(t),s._libraries[e]=o,i.src=e,i.onload=function(){this.ready=!0;for(var e=0;e<this.callbacks.length;++e)this.callbacks[e]();this.callbacks=undefined}.bind(o),document.head.appendChild(i)});return n}return s._libraries[e].ready?(t&&t(),new Promise(function(e,t){e()})):new Promise(function(n,r){var i=s._libraries[e].callbacks;i.push(n),t&&i.push(t)})},s.fetch=function(e,t,n){t||(t="arraybuffer");var r=t+":"+e;return n&&s._resources[r]?s._resources[r].ready?new Promise(function(e,t){e(tma_resources[r].resource)}):new Promise(function(e,t){s._resources[r].callbacks.push(e)}):new Promise(function(i,o){n&&(s._resources[r]={callbacks:[],ready:!1,resource:undefined});var u=new XMLHttpRequest;u.open("GET",e,!0),u.responseType=t,u.onload=function(){if(!this.response)o(this);else{i(this.response);if(n){var e=s._resources[r];e.ready=!0,e.resource=this.response;for(var t=0;t<e.callbacks.length;++t)e.callbacks[t](this.response)}}this.onload=null}.bind(u),u.send()})},s.loadShader=function(e,t){return new Promise(function(n,r){s.fetch(e,"document",!0).then(function(e){n(e.getElementById(t).text)},s.ecb)})},s._boot=function(){var e=new Promise(function(e,t){s.load(s.base+"src/TmaScreen.js").then(function(){Promise.all([s.load(s.base+"src/Tma2DScreen.js"),new Promise(function(e,t){s.load(s.base+"src/Tma3DScreen.js",function(){s.load(s.base+"src/TmaModelPrimitives.js",e)},s.ecb)},s.ecb)]).then(function(){e()},s.ecb)},s.ecb)});Promise.all([e,s.load(s.base+"src/TmaParticle.js"),s.load(s.base+"src/TmaSequencer.js"),s.load(s.base+"src/TmaMotionBvh.js"),s.load(s.base+"src/TmaModelPly.js"),s.load(s.base+"src/TmaModelPs2Ico.js")]).then(function(){s.ready=!0,Promise.all(s.extlibs.map(function(e){return s.load(s.base+e)})).then(function(){s.onload&&s.onload()},s.ebc)},s.ecb)},o.BODY=document.getElementsByTagName("body")[0],o.LOCK=1,o.LOCK_WITH_SCREEN=2,o.MODE_2D=1,o.MODE_3D=2,o.FULL_WIDTH=-1,o.FULL_HEIGHT=-1,o.RGB2HSV=function(e,t,n){var r=0,i=0,s=0;return e>t?e>n?(r=e,i=t>n?n:t,s=60*(t-n)/(r-i)):(r=n,i=t,s=60*(e-t)/(r-i)+240):t>=n?(r=t,i=e>n?n:e,s=60*(n-e)/(r-i)+120):(r=n,i=e,s=60*(e-t)/(r-i)+240),{h:(s+360)%360,s:(r-i)/r,v:r/255}},o.HSV2RGB=function(e,t,n){n*=255;var r=~~n;if(0==t)return{r:r,g:r,b:r};var i=e/60,s=~~i;i-=s;var o=~~(n*(1-t)),u=~~(n*(1-t*i)),a=~~(n*(1-t*(1-i)));switch(s){case 0:return{r:n,g:a,b:o};case 1:return{r:u,g:n,b:o};case 2:return{r:o,g:n,b:a};case 3:return{r:o,g:u,b:n};case 4:return{r:a,g:o,b:n};case 5:return{r:n,g:o,b:u}}},o.prototype.setPixel=function(e,t,n,r,i,s,u){var a=(t*this.width+e)*4,f=this.data;if(u){var l=o.HSV2RGB(n,r,i);f[a+0]=l.r,f[a+1]=l.g,f[a+2]=l.b,f[a+3]=s}else f[a+0]=n,f[a+1]=r,f[a+2]=i,f[a+3]=s},o.prototype.addPixel=function(e,t,n,r,i,s,u){var a=(t*this.width+e)*4,f=this.data;if(u){var l=o.HSV2RGB(n,r,i);f[a+0]+=l.r,f[a+1]+=l.g,f[a+2]+=l.b,f[a+3]=s}else f[a+0]+=n,f[a+1]+=r,f[a+2]+=i,f[a+3]=s},o.prototype.drawLine=function(e,t,n,r,i,s,u,a,f,l){var c=(t*this.width+e)*4,h=this.data,p=i,d=s,v=u;if(f){var m=o.HSV2RGB(i,s,u);p=m.r,d=m.g,v=m.b}var g=n-e,y=r-t,b=g>0?g:-g,w=y>0?y:-y;if(b<w){var E=y>0?1:-1,S=g/y,x=y>0?this.width*4:-this.width*4,T=4;if(l)for(var N=t;;N+=E){var C=c+~~(S*(N-t))*T;h[C+0]+=p,h[C+1]+=d,h[C+2]+=v,h[C+3]=a;if(N==r)break;c+=x}else for(N=t;;N+=E){C=c+~~(S*(N-t))*T,h[C+0]=p,h[C+1]=d,h[C+2]=v,h[C+3]=a;if(N==r)break;c+=x}}else{E=g>0?1:-1,S=y/g,x=this.width*4,T=g>0?4:-4;if(l)for(var k=e;;k+=E){C=c+~~(S*(k-e))*x,h[C+0]+=p,h[C+1]+=d,h[C+2]+=v,h[C+3]=a;if(k==n)break;c+=T}else for(k=e;;k+=E){C=c+~~(S*(k-e))*x,h[C+0]=p,h[C+1]=d,h[C+2]=v,h[C+3]=a;if(k==n)break;c+=T}}},e.TmaScreen=o,u.prototype.attachTo=function(e){e.appendChild(this.canvas)},u.prototype.detachFrom=function(e){e.removeChild(this.canvas)},u.prototype.createImageData=function(e,t){return this.context.createImageData(e,t)},u.prototype.setPixel=o.prototype.setPixel,u.prototype.addPixel=o.prototype.addPixel,u.prototype.drawLine=o.prototype.drawLine,u.prototype.lock=function(e){return o.LOCK_WITH_SCREEN==e?this._image=this.context.getImageData(0,0,this.width,this.height):this._image=this._offscreenImage,this.data=this._image.data,this._image},u.prototype.unlock=function(){this._blurRatio&&this._blurSync?this._offscreenContext.putImageData(this._image,0,0):this.context.putImageData(this._image,0,0),this.applyEffects()},u.prototype.afterimage=function(e){this._afterimage=e},u.prototype.blur=function(e,t,n,r,i,s){this._blurRatio=e,this._blurAlpha=t,this._blurWidth=~~(this.width*e),this._blurHeight=~~(this.height*e);var o=~~((this._blurWidth-this._blurWidth/n)/2),u=~~((this._blurHeight-this._blurHeight/n)/2);this._blurSource.x=o,this._blurSource.y=u,this._blurSource.w=this._blurWidth-o-o,this._blurSource.h=this._blurHeight-u-u,this._blurDestination.x=0,this._blurDestination.y=0,this._blurDestination.w=this.width,this._blurDestination.h=this.height;var a=r>=0?r:-r,f=i>=0?i:-i,l=~~(a*this._blurSource.w/this._blurDestination.w),c=~~(f*this._blurSource.h/this._blurDestination.h);this._blurSource.w-=l,this._blurDestination.w-=a,this._blurSource.h-=c,this._blurDestination.h-=f,r>0?this._blurSource.x+=l:r<0&&(this._blurDestination.x+=l),i>0?this._blurSource.y+=c:i<0&&(this._blurDestination.y+=c),this._blurSync=s},u.prototype.fill=function(e){this.context.strokeStyle=e,this.context.fillStyle=e,this.context.fillRect(0,0,this.width,this.height)},u.prototype.applyEffects=function(){this._applyBlur(),this._applyAfterimage()},u.prototype._applyAfterimage=function(){if(!this._afterimage)return;this.fill(this._afterimage)},u.prototype._applyBlur=function(){if(!this._blurRatio)return;var e,t;this._blurSync?(e=this._offscreenCanvas,t=this._offscreenContext):(e=this.canvas,t=this.context),this._blurContext.drawImage(e,0,0,this.width,this.height,0,0,this._blurWidth,this._blurHeight),t.globalCompositeOperation="lighter",t.globalAlpha=this._blurAlpha,t.drawImage(this._blurCanvas,this._blurSource.x,this._blurSource.y,this._blurSource.w,this._blurSource.h,this._blurDestination.x,this._blurDestination.y,this._blurDestination.w,this._blurDestination.h),t.globalCompositeOperation="source-over",t.globalAlpha=1,this._blurSync&&this.context.drawImage(e,0,0)},u.prototype.mouse=function(){return this._mouse?{over:this._mouse,x:this._mouseX,y:this._mouseY}:{over:this._mouse}},u.prototype._onmousemove=function(e){this._mouse=!0;var t=e.target.getBoundingClientRect();this._mouseX=e.clientX-t.left,this._mouseY=e.clientY-t.top,this._mousePressed&&this.onMouseDrag(this._mouseX,this._mouseY)},u.prototype._onmouseout=function(e){this._mouse=!1},u.prototype._onmousedown=function(e){var t=e.target.getBoundingClientRect();this._mouseX=e.clientX-t.left,this._mouseY=e.clientY-t.top,this._mousePressed=!0,this.onMouseDown(this._mouseX,this._mouseY),this.onMouseDrag(this._mouseX,this._mouseY)},u.prototype._onmouseup=function(e){var t=e.target.getBoundingClientRect();this._mouseX=e.clientX-t.left,this._mouseY=e.clientY-t.top,this._mousePressed=!1,this.onMouseDrag(this._mouseX,this._mouseY),this.onMouseUp(this._mouseX,this._mouseY)},u.prototype.onMouseDown=function(e,t){},u.prototype.onMouseDrag=function(e,t){},u.prototype.onMouseUp=function(e,t){},e.Tma2DScreen=u,a.VERTEX_SHADER=1,a.FRAGMENT_SHADER=2,a._MODE_INITIALIZED=!1,a.MODE_POINTS=0,a.MODE_LINES=1,a.MODE_LINE_LOOP=2,a.MODE_LINE_STRIP=3,a.MODE_TRIANGLES=4,a.MODE_TRIANGLE_STRIP=5,a.MODE_TRIANGLE_FAN=6,a.FILTER_NEAREST=9728,a.FILTER_LINEAR=9729,a.prototype.attachTo=function(e){e.appendChild(this.canvas)},a.prototype.detachFrom=function(e){e.removeChild(this.canvas)},a.prototype.compileShader=function(e,t){var e=a.VERTEX_SHADER==e?this.gl.VERTEX_SHADER:this.gl.FRAGMENT_SHADER,n=this.gl.createShader(e);return this.gl.shaderSource(n,t),this.gl.compileShader(n),this.gl.getShaderParameter(n,this.gl.COMPILE_STATUS)||s.log("WebGL compiling shader: "+this.gl.getShaderInfoLog(n)+" : "+t),n},a.prototype.loadShader=function(e,t){return this.compileShader(e,document.getElementById(t).text)},a.prototype.linkProgram=function(e){this.gl.linkProgram(e),this.gl.getProgramParameter(e,this.gl.LINK_STATUS)||s.log("WebGL link program error: "+this.gl.getProgramInfoLog(e)),s.log("WebGL program active attributes "+this.gl.getProgramParameter(e,this.gl.ACTIVE_ATTRIBUTES))},a.prototype.createProgram=function(e,t){var n=this.gl.createProgram();return e.constructor.name&&"WebGLShader"!=e.constructor.name&&(e=this.loadShader(a.VERTEX_SHADER,e)),this.gl.attachShader(n,e),t.constructor.name&&"WebGLShader"!=t.constructor.name&&(t=this.loadShader(a.FRAGMENT_SHADER,t)),this.gl.attachShader(n,t),this.linkProgram(n),n._owner=this,n._index=0,n._textureId=0,n._textureIdMap={},n._attributes={},n._uniforms={},n.attributeIndex=function(e){return this._attributes[e]||(this._attributes[e]=this._owner.gl.getAttribLocation(this,e)),this._attributes[e]},n.uniformIndex=function(e){return this._uniforms[e]||(this._uniforms[e]=this._owner.gl.getUniformLocation(this,e)),this._uniforms[e]},n.setAttribute=function(e,t){var n=this._attributeIndex(e);this._owner.setAttribute(this,n,t)},n.setAttributeArray=function(e,t,n,r,i){var s=this.attributeIndex(e);t.bind(),this._owner.setAttributeArray(this,s,n,r,i)},n.setUniformVector=function(e,t){var n=this.uniformIndex(e);this._owner.setUniformVector(this,n,t)},n.setUniformMatrix=function(e,t){var n=this.uniformIndex(e);this._owner.setUniformMatrix(this,n,t)},n.setTexture=function(e,t){var n=this.uniformIndex(e),r=this._textureIdMap[e];r||(r=this._textureId++,this._textureIdMap[e]=r),this._owner.setTexture(this,n,r,t)},n.drawArrays=function(e,t,n){this._owner.drawArrays(this,e,t,n)},n.drawElements=function(e,t,n,r){t.bind(),this._owner.drawElements(this,e,n,r)},n},a.prototype.createBuffer=function(e){var t=this.gl.createBuffer();return t._buffer=e.constructor.name=="Float32Array"?e:new Float32Array(e),t._owner=this,t.bind=function(){this._owner.gl.bindBuffer(this._owner.gl.ARRAY_BUFFER,this)},t.buffer=function(){return this._buffer},t.update=function(){this.bind();var e=this._owner.gl;e.bufferData(e.ARRAY_BUFFER,t._buffer,e.STATIC_DRAW)},t.deleteBuffer=function(){this._owner.gl.deleteBuffer(this),this._buffer=null,this._owner=null},t.update(),t},a.prototype.createElementBuffer=function(e){var t=this.gl.createBuffer();return this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,t),this.gl.bufferData(this.gl.ELEMENT_ARRAY_BUFFER,new Uint16Array(e),this.gl.STATIC_DRAW),t._owner=this,t.bind=function(){this._owner.gl.bindBuffer(this._owner.gl.ELEMENT_ARRAY_BUFFER,this)},t},a.prototype.createFrameBuffer=function(e,t){var n=this.gl.createFramebuffer();return n.width=e,n.height=t,n._owner=this,n.texture=null,n.renderbuffer=null,n.bind=function(){var e=this._owner._lastBoundFrameBuffer;if(e==this)return e;this._owner._lastBoundFrameBuffer=this;var t=this._owner.gl;return t.bindFramebuffer(t.FRAMEBUFFER,this),this.texture||(this.texture=t.createTexture(),t.bindTexture(t.TEXTURE_2D,this.texture),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,this.width,this.height,0,t.RGBA,t.UNSIGNED_BYTE,null),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.texture,0)),this.renderbuffer||(this.renderbuffer=t.createRenderbuffer(),t.bindRenderbuffer(t.RENDERBUFFER,this.renderbuffer),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,this.width,this.height),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,this.renderbuffer)),t.viewport(0,0,this.width,this.height),e},n},a.prototype.createImage=function(e,t,n){var r=this.context.createImageData(e,t);if(n){var i=r.data,s=e*t*4;for(var u=0;u<s;++u)i[u]=n[u]}return r.setPixel=o.prototype.setPixel,r.addPixel=o.prototype.addPixel,r.drawLine=o.prototype.drawLine,r},a.prototype.convertImage=function(e){this.canvas2d.width=e.width,this.canvas2d.height=e.height,this.context.drawImage(e,0,0);var t=this.context.getImageData(0,0,e.width,e.height);return this.createImage(t.width,t.height,t.data)},a.prototype.createStringTexture=function(e,t,n){var r=t.size+"px "+t.name;this.context.font=r;var i=this.context.measureText(e).width,s=t.size*devicePixelRatio*1.5;n&&(n.width&&(i=n.width),n.height&&(s=n.height)),this.canvas2d.width=i,this.canvas2d.height=s,this.context.font=r,this.context.fillStyle=t.background,this.context.fillRect(0,0,i,s),this.context.fillStyle=t.foreground,this.context.textAlign="center",this.context.textBaseline="middle",this.context.fillText(e,i/2,s/2);var o=this.context.getImageData(0,0,i,s),u=this.createImage(o.width,o.height,o.data);return this.createTexture(u,!0,a.FILTER_LINEAR)},a.prototype.createFloatTexture=function(e,t,n,r){var i=this.gl.createTexture();return i.width=t,i.height=n,i.data=e,this.gl.bindTexture(this.gl.TEXTURE_2D,i),this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,r),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,t,n,0,this.gl.RGBA,this.gl.FLOAT,e),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),i._flip=r,i._owner=this,i.update=function(e){var t=this._owner.gl;t.bindTexture(t.TEXTURE_2D,this),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,this.width,this.height,0,t.RGBA,t.FLOAT,e)},i},a.prototype.createTexture=function(e,t,n){var r=this.gl.createTexture();return r.width=e.width,r.height=e.height,r.image=e,this.gl.bindTexture(this.gl.TEXTURE_2D,r),this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,t),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,e),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,n),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,n),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),r._flip=t,r._owner=this,r.update=function(e){var t=this._owner.gl;t.bindTexture(t.TEXTURE_2D,this),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e)},r},a.prototype.bind=function(){var e=this._lastBoundFrameBuffer;return this._lastBoundFrameBuffer=this,this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),this.gl.viewport(0,0,this.width,this.height),e},a.prototype.setAttribute=function(e,t,n){this.gl.useProgram(e),1==n.length?this.gl.vertexAttrib1fv(t,n):2==n.length?this.gl.vertexAttrib2fv(t,n):3==n.length?this.gl.vertexAttrib3fv(t,n):4==n.length&&this.gl.vertexAttrib4fv(t,n),this.gl.disableVertexAttribArray(t)},a.prototype.setAttributeArray=function(e,t,n,r,i){this.gl.useProgram(e),this.gl.vertexAttribPointer(t,r,this.gl.FLOAT,!1,i,n),this.gl.enableVertexAttribArray(t)},a.prototype.setUniformVector=function(e,t,n){this.gl.useProgram(e),1==n.length?this.gl.uniform1fv(t,n):2==n.length?this.gl.uniform2fv(t,n):3==n.length?this.gl.uniform3fv(t,n):4==n.length?this.gl.uniform4fv(t,n):s.error("WebGL unknown uniform vector size: "+n.length)},a.prototype.setUniformMatrix=function(e,t,n){this.gl.useProgram(e),4==n.length?this.gl.uniformMatrix2fv(t,!1,n):9==n.length?this.gl.uniformMatrix3fv(t,!1,n):16==n.length?this.gl.uniformMatrix4fv(t,!1,n):s.error("WebGL unknown uniform matrix size: "+n.length)},a.prototype.setTexture=function(e,t,n,r){this.gl.useProgram(e),this.gl.activeTexture(this.gl.TEXTURE0+n),this.gl.bindTexture(this.gl.TEXTURE_2D,r),this.gl.uniform1i(t,n)},a.prototype.drawArrays=function(e,t,n,r){this.gl.useProgram(e),this.gl.drawArrays(t,n,r)},a.prototype.drawElements=function(e,t,n,r){this.gl.useProgram(e),this.gl.drawElements(t,r,this.gl.UNSIGNED_SHORT,n)},a.prototype.fillColor=function(e,t,n,r){this.gl.clearColor(e,t,n,r),this.gl.clearDepth(1),this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT)},a.prototype.setAlphaMode=function(e,t,n){this._currentAlphaMode={on:e,src:t,dst:n},e?(this.gl.disable(this.gl.DEPTH_TEST),this.gl.enable(this.gl.BLEND),this.gl.blendFunc(t,n)):(this.gl.disable(this.gl.BLEND),this.gl.enable(this.gl.DEPTH_TEST),this.gl.depthFunc(this.gl.LEQUAL))},a.prototype.pushAlphaMode=function(){this._alphaModeStack.push(this._currentAlphaMode)},a.prototype.popAlphaMode=function(){var e=this._alphaModeStack.pop();this.setAlphaMode(e.on,e.src,e.dst)},a.prototype.setCullingMode=function(e,t){this._currentCullingMode={on:e,ccw:t},e?(this.gl.enable(this.gl.CULL_FACE),this.gl.frontFace(t?this.gl.CCW:this.gl.CW)):this.gl.disable(this.gl.CULL_FACE)},a.prototype.pushCullingMode=function(){this._cullingModeStack.push(this._currentCullingMode)},a.prototype.popCullingMode=function(){var e=this._cullingModeStack.pop();this.setCullingMode(e.on,e.ccw)},a.prototype.setLineWidth=function(e){this.gl.lineWidth(e)},a.prototype.flush=function(){this.gl.flush()},a.prototype.mouse=function(){return this._mouse?{over:this._mouse,x:this._mouseX,y:this._mouseY,click:{on:this._mousePressed,x:this._mouseClickX,y:this._mouseClickY},width:this._mouseWidth,height:this._mouseHeight}:{over:!1,x:0,y:0,click:{on:!1,x:0,y:0},width:0,height:0}},a.prototype._onmousemove=function(e){this._mouse=!0;var t=e.target.getBoundingClientRect();this._mouseX=e.clientX-t.left,this._mouseY=e.clientY-t.top,this._mouseWidth=t.right-t.left,this._mouseHeight=t.bottom-t.top,this._mousePressed&&this.onMouseDrag(this._mouseX,this._mouseY)},a.prototype._onmouseout=function(e){this._mouse=!1},a.prototype._onmousedown=function(e){var t=e.target.getBoundingClientRect();this._mouseX=e.clientX-t.left,this._mouseY=e.clientY-t.top,this._mousePressed=!0,this._mouseClickX=this._mouseX,this._mouseClickY=this._mouseY,this.onMouseDown(this._mouseX,this._mouseY),this.onMouseDrag(this._mouseX,this._mouseY)},a.prototype._onmouseup=function(e){var t=e.target.getBoundingClientRect();this._mouseX=e.clientX-t.left,this._mouseY=e.clientY-t.top,this._mousePressed=!1,this.onMouseDrag(this._mouseX,this._mouseY),this.onMouseUp(this._mouseX,this._mouseY)},a.prototype.onMouseDown=function(e,t){},a.prototype.onMouseDrag=function(e,t){},a.prototype.onMouseUp=function(e,t){},e.Tma3DScreen=a,f.prototype.scale=function(e){for(var t=0;t<this._vertices.length;++t)this._vertices[t]*=e},f.prototype.items=function(){return this._indices.length},f.prototype.getVertices=function(){return this._vertices},f.prototype.getCoords=function(){return this._coords},f.prototype.getIndices=function(){return this._indices},f.prototype.getColors=function(){return this._colors},f.prototype.getVerticesBuffer=function(e){return this._verticesBuffer||(this._verticesBuffer=e.createBuffer(this.getVertices())),this._verticesBuffer},f.prototype.getCoordsBuffer=function(e){return this._coordsBuffer||(this._coordsBuffer=e.createBuffer(this.getCoords())),this._coordsBuffer},f.prototype.getIndicesBuffer=function(e){return this._indicesBuffer||(this._indicesBuffer=e.createElementBuffer(this.getIndices())),this._indicesBuffer},f.prototype.getColorsBuffer=function(e){return this._colorsBuffer||(this._colorsBuffer=e.createBuffer(this.getColors())),this._colorsBuffer},f.prototype.setTexture=function(e){this._texture=e},f.prototype.getTexture=function(){return this._texture},f.prototype.setDrawMode=function(e){this._mode=e},f.prototype.getDrawMode=function(){return this._mode},f.prototype._createBox=function(){this._vertices=[-0.5,-0.5,0,.5,-0.5,0,.5,.5,0,-0.5,.5,0],this._indices=[0,1,2,2,3,0],this._coords=[0,0,1,0,1,1,0,1]},f.prototype._createCube=function(){this._vertices=[-0.5,-0.5,-0.5,-0.5,-0.5,.5,-0.5,.5,-0.5,-0.5,.5,.5,.5,-0.5,-0.5,.5,-0.5,.5,.5,.5,-0.5,.5,.5,.5],this._indices=[1,5,7,7,3,1,3,7,6,6,2,3,2,6,4,4,0,2,0,4,5,5,1,0,4,6,7,7,5,4,0,1,3,3,2,0],this._coords=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]},f.prototype._createPoints=function(e){this._vertices=e;var t=e.length/3;this._indices=new Array(t),this._colors=new Array(t*4),this._coords=null;for(var n=0;n<t;++n)this._indices[n]=n,this._colors[n*4+0]=1,this._colors[n*4+1]=1,this._colors[n*4+2]=1,this._colors[n*4+3]=1;this._mode=a.MODE_POINTS},f.prototype._createSphereEven=function(e){var t=[[1,0,0],[0,1,0],[-1,0,0],[0,-1,0]],n=function(e,t){var n=this._vertices.length/3,r=Math.sqrt(e[0]*e[0]+e[1]*e[1]),i=.5;r!=0&&(i=Math.acos(e[0]/r)/Math.PI/2),e[1]<0&&(i=1-i),i==0&&!t&&(i=1);var s=1-Math.acos(e[2])/Math.PI;for(var o=0;o<n;++o){if(this._vertices[o*3+0]!=e[0]||this._vertices[o*3+1]!=e[1]||this._vertices[o*3+2]!=e[2]||this._coords[o*2+0]!=i||this._coords[o*2+1]!=s)continue;this._indices.push(o);return}this._indices.push(o),this._vertices=this._vertices.concat(e),this._coords.push(i),this._coords.push(s)}.bind(this),i=function(e,t,r){var i=(e[1]+t[1]+r[1])/3>0;n(e,i),n(t,i),n(r,i)}.bind(this),s=function(e,t,n,o){if(e==0){i(t,n,o);return}e--;var u=function(e,t){var n=(e[0]+t[0])/2,i=(e[1]+t[1])/2,s=(e[2]+t[2])/2;return r=Math.sqrt(n*n+i*i+s*s),[n/r,i/r,s/r]},a=u(t,n),f=u(n,o),l=u(o,t);s(e,t,a,l),s(e,a,n,f),s(e,f,o,l),s(e,a,f,l)};for(var o=0;o<t.length;++o){var u=(o+1)%t.length;s(e,t[o],t[u],[0,0,1]),s(e,t[o],t[u],[0,0,-1])}},f.SPHERE_METHOD_THEODOLITE=0,f.SPHERE_METHOD_EVEN=1,f.createBox=function(){var e=new f;return e._createBox(),e},f.createCube=function(){var e=new f;return e._createCube(),e},f.createPoints=function(e){var t=new f;return t._createPoints(e),t},f.createSphere=function(e,t){var n=new f;return n._createSphereEven(e),n},e.TmaModelPrimitives=f,l.prototype.initialize=function(){},l.prototype.update=function(){return!1},l.prototype.remove=function(){this._container.remove(this._offset)},l.Container=function(e){this.length=0,this._func=e,this._particles=[]},l.Container.prototype.at=function(e){return this._particles[e]},l.Container.prototype.add=function(){this._particles.length==this.length&&(this._particles[this.length]=new this._func(this,this.length)),this._particles[this.length].initialize.apply(this._particles[this.length++],arguments)},l.Container.prototype.remove=function(e){var t=this._particles[e];t._offset=--this.length,this._particles[e]=this._particles[this.length],this._particles[e]._offset=e,this._particles[this.length]=t},l.Container.prototype.update=function(){for(var e=0;e<this.length;)this._particles[e].update.apply(this._particles[e],arguments)?e++:this.remove(e)},e.TmaParticle=l,c.prototype.start=function(e){this.stop(),this._elapsed=0},c.prototype.stop=function(){for(var e=0;e<this._active.length;++e)this._active[e].task.stop();this._queue=this._finished.concat(this._active,this._queue),this._active=[],this._finished=[]},c.prototype.run=function(e){this._elapsed+=e;var t=[];for(var n=0;n<this._active.length;++n){var r=this._active[n].task.run(e,this._elapsed);r==0?t.push(this._active[n]):(this._active[n].task.stop(),this._finished.push(this._active[n]))}this._active=t;while(this._queue.length>0&&this._queue[0].when<this._elapsed){var i=this._queue.shift();i.task.start();var r=i.task.run(this._elapsed-i.when,this._elapsed);r==0?t.push(i):(i.task.stop(),this._finished.push(i))}},c.prototype.register=function(e,t){var n={when:e,task:t};for(var r=0;r<this._queue.length;++r){if(this._queue[r].when<=e)continue;r==0?this._queue=this._unshift(n):this._queue=this._queue.slice(0,r).concat([n],this._queue.slice(r,this._queue.length));return}this._queue.push(n)},c.prototype.elapsed=function(){return this._elapsed},c.prototype.active=function(){return this._active.length!=0||this._queue.length!=0},c.Task=function(e,t){this.reset(e),this._callback=t},c.Task.INFINITE=-1,c.Task.prototype.reset=function(e){this._duration=e,this._elapsed=0},c.Task.prototype.start=function(){this.stop(),this._elapsed=0},c.Task.prototype.stop=function(){},c.Task.prototype.atEnd=function(){return this._duration!=c.Task.INFINITE&&this._elapsed>=this._duration},c.Task.prototype.spend=function(e){return this._elapsed+=e,this._duration==c.Task.INFINITE?0:this._elapsed<=this._duration?0:this._elapsed-this._duration},c.Task.prototype.run=function(e,t){return this._callback&&this._callback(e,t),this.spend(e)},c.Task.prototype.duration=function(){return this._duration},c.SerialTask=function(){this.superclass(0),this._queue=[],this._active=null,this._finished=[],this._start=0},c.SerialTask.prototype=new c.Task,c.SerialTask.prototype.superclass=c.Task,c.SerialTask.prototype.constructor=c.SerialTask,c.SerialTask.prototype.append=function(e){var t=e.duration();t==c.Task.INFINITE?this._duration=c.Task.INFINITE:this._duration+=t,this._queue.push(e)},c.SerialTask.prototype.start=function(){this.stop(),this._elapsed=0,this._timeBase=-1,this._active=this._queue.shift(),this._active.start()},c.SerialTask.prototype.stop=function(){this._active&&(this._active.stop(),this._finished.push(this._active),this._active=null),this._queue=this._finished.concat(this._queue),this._finished=[]},c.SerialTask.prototype.run=function(e,t){this._timeBase<0&&(this._timeBase=t-e);var n=e,r=t-this._timeBase;while(this._active){var i=this._active.run(n,r);if(i==0)return this.spend(n);var s=n-i;n=i,this._active.stop(),this._finished.push(this._active),this._active=this._queue.shift(),this._active&&this._active.start()}return this.spend(e)},c.ParallelTask=function(){this.superclass(0),this._active=[],this._finished=[],this._timeBase=-1},c.ParallelTask.prototype=new c.Task,c.ParallelTask.prototype.superclass=c.Task,c.ParallelTask.prototype.constructor=c.ParallelTask,c.ParallelTask.prototype.append=function(e){var t=e.duration();t==c.Task.INFINITE?this._duration=c.Task.INFINITE:this._duration!=c.Task.INFINITE&&(this._duration=Math.max(this._duration,t)),this._active.push(e)},c.ParallelTask.prototype.start=function(){this.stop(),this._elapsed=0,this._timeBase=-1;for(var e=0;e<this._active.length;++e)this._active[e].start()},c.ParallelTask.prototype.stop=function(){for(var e=0;e<this._active.length;++e)this._active[e].stop(),this._finished.push(this._active[e]);this._active=this._finished,this._finished=[]},c.ParallelTask.prototype.run=function(e,t){this._timeBase<0&&(this._timeBase=t-e);var n=[],r=t-this._timeBase;for(var i=0;i<this._active.length;++i){var s=this._active[i].run(e,r);this._active[i].atEnd()?(this._active[i].stop(),this._finished.push(this._active[i])):n.push(this._active[i])}return this._active=n,this.spend(e)},c.RepeatTask=function(e,t){var n=c.Task.INFINITE;typeof t=="undefined"&&(t=c.RepeatTask.INFINITE),t!=c.RepeatTask.INFINITE&&(n=e.duration()*t),this.superclass(n),this._task=e,this._iteration=t,this._count=0,this._timeBase=-1},c.RepeatTask.INFINITE=-1,c.RepeatTask.prototype=new c.Task,c.RepeatTask.prototype.superclass=c.Task,c.RepeatTask.prototype.constructor=c.RepeatTask,c.RepeatTask.prototype.start=function(){this.stop(),this._elapsed=0,this._timeBase=-1,this._count=0,this._task.start()},c.RepeatTask.prototype.stop=function(){this._task.stop()},c.RepeatTask.prototype.run=function(e,t){if(this._count==this._iteration)return e;this._timeBase<0&&(this._timeBase=t-e);var n=t-this._timeBase,r=e;while(r>0){var i=this._task.run(r,n);this.spend(r-i);if(this._task.atEnd()){this._task.stop(),this._count++;if(this._count==this._iteration)return i;this._task.start()}r=i}return 0},h._CODE_A="A".charCodeAt(0),h._CODE_Z="Z".charCodeAt(0),h._CODE_a="a".charCodeAt(0),h._CODE_z="z".charCodeAt(0),h._CODE_0="0".charCodeAt(0),h._CODE_9="9".charCodeAt(0),h._CODE_DOT=".".charCodeAt(0),h._CODE_MINUS="-".charCodeAt(0),h._CASE_CHANNELS="C".charCodeAt(0),h._CASE_ENDSITE="E".charCodeAt(0),h._CASE_FRAME="F".charCodeAt(0),h._CASE_HIERARCHY="H".charCodeAt(0),h._CASE_JOINT="J".charCodeAt(0),h._CASE_MOTION="M".charCodeAt(0),h._CASE_OFFSET="O".charCodeAt(0),h._CASE_ROOT="R".charCodeAt(0),h._CASE_X="X".charCodeAt(0),h._CASE_Y="Y".charCodeAt(0),h._CASE_Z="Z".charCodeAt(0),h._CASE_POSITION="p".charCodeAt(0),h._CASE_ROTATION="r".charCodeAt(0),h._CASE_BEGIN="{".charCodeAt(0),h._CASE_END="}".charCodeAt(0),h._CASE_SP=" ".charCodeAt(0),h._CASE_CR="\r".charCodeAt(0),h._CASE_LF="\n".charCodeAt(0),h._KEY_CHANNELS="CHANNELS",h._KEY_ENDSITE="End Site",h._KEY_HIERARCHY="HIERARCHY",h._KEY_JOINT="JOINT",h._KEY_MOTION="MOTION",h._KEY_OFFSET="OFFSET"
,h._KEY_ROOT="ROOT",h._KEY_POSITION="position",h._KEY_ROTATION="rotation",h._KEY_FRAMES="Frames: ",h._KEY_FRAME_TIME="Frame Time: ",h._ID_UNKNOWN=-2,h._ID_EOF=-1,h._ID_CHANNELS=1,h._ID_ENDSITE=2,h._ID_HIERARCHY=3,h._ID_JOINT=4,h._ID_MOTION=5,h._ID_OFFSET=6,h._ID_ROOT=7,h._ID_XPOSITION=8,h._ID_YPOSITION=9,h._ID_ZPOSITION=10,h._ID_XROTATION=11,h._ID_YROTATION=12,h._ID_ZROTATION=13,h._ID_BEGIN=14,h._ID_END=15,h._ID_NAME=16,h._ID_NUMBER=17,h._ID_FRAMES=18,h._ID_FRAME_TIME=19,h._isNumber=function(e){return h._CODE_0<=e&&e<=h._CODE_9?!0:!1},h._isAlphabet=function(e){return h._CODE_A<=e&&e<=h._CODE_Z?!0:h._CODE_a<=e&&e<=h._CODE_z?!0:!1},h._checkKey=function(e,t){var n=t.length;if(e.offset+n>e.byteLength)return!1;for(var r=0;r<n;r++)if(e.data[e.offset+r]!=t.charCodeAt(r))return!1;return e.offset+=n,!0},h._parseJoint=function(e,t,n){var r=h._parse(e);if(h._ID_BEGIN!=r.id)return s.error("BVH: JOINT/End Site doesn't start with '{'"),!1;t.site=n,t.joint=[],t.totalChannels=0;for(;;){r=h._parse(e);switch(r.id){case h._ID_CHANNELS:if(n)return s.error("BVH: End Site can not have a CHANNELS"),!1;r=h._parse(e);if(h._ID_NUMBER!=r.id)return s.error("BVH: CHANNELS requires a number"),!1;var i=r.value;t.channels={Xposition:!1,Yposition:!1,Zposition:!1,Xrotation:!1,Yrotation:!1,Zrotation:!1};for(var o=0;o<i;o++){r=h._parse(e);switch(r.id){case h._ID_XPOSITION:t.channels.Xposition=!0;break;case h._ID_YPOSITION:t.channels.Yposition=!0;break;case h._ID_ZPOSITION:t.channels.Zposition=!0;break;case h._ID_XROTATION:t.channels.Xrotation=!0;break;case h._ID_YROTATION:t.channels.Yrotation=!0;break;case h._ID_ZROTATION:t.channels.Zrotation=!0;break;default:return s.error("BVH: CHANNELS has unknown channel keyword"),!1}}t.totalChannels+=i;break;case h._ID_END:return!0;case h._ID_ENDSITE:var u={name:"End Site"};s.log("BVH: End Site"),t.joint.push(u);if(!h._parseJoint(e,u,!0))return!1;break;case h._ID_JOINT:if(n)return s.error("BVH: End Site can not have a JOINT"),!1;r=h._parse(e);if(h._ID_NAME!=r.id)return s.error("BVH: JOINT doesn't have a name"),!1;var a={name:r.value};s.log("BVH: JOINT "+r.value),t.joint.push(a);if(!h._parseJoint(e,a,!1))return!1;t.totalChannels+=a.totalChannels;break;case h._ID_OFFSET:r=h._parse(e);if(h._ID_NUMBER==r.id){var f=r.value;r=h._parse(e);if(h._ID_NUMBER==r.id){var l=r.value;r=h._parse(e);if(h._ID_NUMBER==r.id){var c=r.value;t.offset={x:f,y:l,z:c};break}}}return s.error("BVH: OFFSET requires three numbers"),!1;default:return s.error("BVH: internal error"),!1}}return!0},h._parse=function(e){var t=e.data.byteLength;for(var n={id:h._ID_UNKNOWN};e.offset<t;e.offset++){var r=e.data[e.offset],i=[];switch(r){case h._CASE_CHANNELS:if(!h._checkKey(e,h._KEY_CHANNELS))break;return{id:h._ID_CHANNELS};case h._CASE_ENDSITE:if(!h._checkKey(e,h._KEY_ENDSITE))break;return{id:h._ID_ENDSITE};case h._CASE_FRAME:if(h._checkKey(e,h._KEY_FRAMES))return{id:h._ID_FRAMES};if(h._checkKey(e,h._KEY_FRAME_TIME))return{id:h._ID_FRAME_TIME};break;case h._CASE_HIERARCHY:if(!h._checkKey(e,h._KEY_HIERARCHY))break;return{id:h._ID_HIERARCHY};case h._CASE_JOINT:if(!h._checkKey(e,h._KEY_JOINT))break;return{id:h._ID_JOINT};case h._CASE_MOTION:if(!h._checkKey(e,h._KEY_MOTION))break;return{id:h._ID_MOTION};case h._CASE_OFFSET:if(!h._checkKey(e,h._KEY_OFFSET))break;return{id:h._ID_OFFSET};case h._CASE_ROOT:if(!h._checkKey(e,h._KEY_ROOT))break;return{id:h._ID_ROOT};case h._CASE_X:i=[h._ID_XPOSITION,h._ID_XROTATION];break;case h._CASE_Y:i=[h._ID_YPOSITION,h._ID_YROTATION];break;case h._CASE_Z:i=[h._ID_ZPOSITION,h._ID_ZROTATION];break;case h._CASE_BEGIN:return e.offset++,{id:h._ID_BEGIN};case h._CASE_END:return e.offset++,{id:h._ID_END};case h._CASE_SP:case h._CASE_CR:case h._CASE_LF:continue;default:}if(0!=i.length&&e.offset+1<t){var o=e.data[++e.offset];if(h._CASE_POSITION==o){if(h._checkKey(e,h._KEY_POSITION))return{id:i[0]}}else if(h._CASE_ROTATION==o&&h._checkKey(e,h._KEY_ROTATION))return{id:i[1]};e.offset--}var u;if(h._isAlphabet(e.data[e.offset])){for(var a=[];e.offset<e.data.byteLength;e.offset++){u=e.data[e.offset];if(!h._isAlphabet(u)&&!h._isNumber(u))break;a.push(String.fromCharCode(u))}return{id:h._ID_NAME,value:a.join("")}}var f=[];h._CODE_MINUS==e.data[e.offset]&&(f.push("-"),e.offset++);for(var l=!1;e.offset<e.data.byteLength;e.offset++){u=e.data[e.offset];if(h._CODE_DOT==u){if(l)return s.warn("BVH: dot apears twice for a number"),n;l=!0}else if(!h._isNumber(u))break;f.push(String.fromCharCode(u))}return 0==f.length?n:{id:h._ID_NUMBER,value:Number(f.join(""))}}return{id:h._ID_EOF}},h.prototype.load=function(e){var t={data:new Uint8Array(e),offset:0},n=h._parse(t);if(h._ID_HIERARCHY!=n.id)return s.error("BVH: HIERARCHY not found"),!1;n=h._parse(t);if(h._ID_ROOT!=n.id)return s.error("BVH: ROOT not found"),!1;n=h._parse(t);if(h._ID_NAME!=n.id)return s.error("BVH: ROOT doesn't have a name"),!1;s.log("BVH: ROOT "+n.value);var r={name:n.value};if(!h._parseJoint(t,r,!1))return!1;n=h._parse(t);if(h._ID_MOTION!=n.id)return s.error("BVH: MOTION not found"),!1;n=h._parse(t);if(h._ID_FRAMES!=n.id)return s.error("BVH: Frames not found"),!1;n=h._parse(t);if(h._ID_NUMBER!=n.id)return s.error("BVH: Frames doesn't have a number"),!1;s.log("BVH: Frames "+n.value),this.frameLength=n.value,n=h._parse(t);if(h._ID_FRAME_TIME!=n.id)return s.error("BVH: Frame Time not found"),!1;n=h._parse(t);if(h._ID_NUMBER!=n.id)return s.error("BVH: Frame Time doesn't have a number"),!1;s.log("BVH: Frame Time "+n.value),this.frameTime=n.value,s.log("BVH: Total Channels "+r.totalChannels),this._frameData=[];for(var i=0;i<this.frameLength;i++){var e=[];for(var o=0;o<r.totalChannels;o++){n=h._parse(t);if(h._ID_NUMBER!=n.id)return s.error("BVH: data broken at frame "+i),!1;e.push(n.value)}this._frameData.push(e)}return s.log("BVH: done"),n=h._parse(t),h._ID_EOF!=n.id&&s.warn("BVH: unused data exists"),this._root=r,!0},h.prototype.getFrameAt=function(e){return this._frameData[e]},e.TmaMotionBvh=h,p.prototype.load=function(e){var t=new function(e){typeof e=="string"?(this._data=e,this._cr="\r",this._lf="\n",this._sp=" ",this._conv=function(e){return e}):(this._data=new Uint8Array(e),this._cr=13,this._lf=10,this._sp=32,this._conv=function(e){return String.fromCharCode(e)}),this._offset=0,this.readNextLine=function(){var e=[],t=this._offset;for(;t<this._data.length;++t){if(this._data[t]==this._cr||this._data[t]==this._lf)break;(e[e.length-1]!=" "||this._data[t]!=this._sp)&&e.push(this._conv(this._data[t]))}if(e.length==0&&t==this._data.length)return null;this._data[t]==this._cr&&t+1<this._data.length&&this._data[t+1]==this._lf&&++t,t!=this._data.length&&t++,this._offset=t;while(e.length>0&&e[e.length-1]==" ")e.pop();return e.join("")},this.next=function(){var e=this.readNextLine();return e?e.split(" "):null}}(e),n;do n=t.readNextLine();while(n!==null&&n.length==0);if(n===null||n!="ply")return s.error("ply: can not find magic word 'ply'"),!1;var r=!1,o=!1,u={},a=null;while(!o){var f=t.next();switch(f[0]){case"comment":f.shift(),s.info("ply: header comment: "+f.join(" "));break;case"element":if(f.length!=3)return s.error("ply: format error: "+f.join(" ")),!1;u[f[1]]=a={},a.count=parseInt(f[2]),a.keys=0,a.key={},a.data=[];break;case"end_header":o=!0;break;case"format":if(f.length!=3||f[1]!="ascii"||f[2]!="1.0")return s.error("ply: unknown "+f.join(" ")),!1;r=!0;break;case"property":if(!a)return s.error("ply: property should follow element: "+f.join(" ")),!1;if(f.length!=3&&f[1]!="list")return s.error("ply: format error: "+f.join(" ")),!1;f[1]=="list"?a.key[f[f.length-1]]={index:a.keys++,type:f[1]}:f[1]=="float"||f[1]=="float32"||f[1]=="int"||f[1]=="uchar"?a.key[f[2]]={index:a.keys++,type:f[1]}:s.error("ply: type "+f[1]+" is not supported");break;default:return s.error("ply: unknown header: "+f.join(" ")),!1}}if(!r)return s.error("ply: format is not specified"),!1;if(!u.vertex||!u.vertex.key.x||!u.vertex.key.y||!u.vertex.key.z)return s.error("ply: vertex element with x, y, and z is not found"),!1;for(var l=0;l<u.vertex.count;l++){var c=t.next();if(c.length!=u.vertex.keys)return s.error("ply: vertex element doesn't contain enough properties"),!1;var h=[];for(i=0;i<c.length;++i)h.push(parseFloat(c[i]));u.vertex.data.push(h)}if(!u.face)return s.error("ply: face element is not found"),!1;for(var p=0;p<u.face.count;p++){var d=t.next();if(d.length!=parseInt(d[0])+1)return s.error("ply: face element doesn't contain enough properties"),!1;var v=[];for(i=0;i<d.length;++i)v.push(parseInt(d[i]));u.face.data.push(v)}for(i=0;i<u.vertex.count;++i)this._vertices.push(u.vertex.data[i][u.vertex.key.x.index]),this._vertices.push(u.vertex.data[i][u.vertex.key.y.index]),this._vertices.push(u.vertex.data[i][u.vertex.key.z.index]);for(i=0;i<u.face.count;++i)u.face.data[i].length==4?(this._indices.push(u.face.data[i][1]),this._indices.push(u.face.data[i][2]),this._indices.push(u.face.data[i][3])):(this._indices.push(u.face.data[i][1]),this._indices.push(u.face.data[i][2]),this._indices.push(u.face.data[i][3]),this._indices.push(u.face.data[i][3]),this._indices.push(u.face.data[i][4]),this._indices.push(u.face.data[i][1]));return!0},p.prototype.scale=function(e){for(var t=0;t<this._vertices.length;++t)this._vertices[t]*=e},p.prototype.getVertices=function(){return this._vertices},p.prototype.getCoords=function(){return this._coord},p.prototype.getIndices=function(){return this._indices},e.TmaModelPly=p,d._OFFSET_VERSION=0,d._OFFSET_NBSP=4,d._OFFSET_ATTRIB=8,d._OFFSET_BFACE=12,d._OFFSET_NBVTX=16,d._OFFSET_VTX=20,d._ATTRIB_IIP=1,d._ATTRIB_ANTI=2,d._ATTRIB_TEX=4,d._ATTRIB_RLE=8,d.prototype.load=function(e){var t=new DataView(e),n=t.getUint32(d._OFFSET_VERSION,!0);if(n!=65536)return s.error("PS2ICO: Unknown version format"),!1;s.info("PS2ICO: version 1.00");var r=t.getUint32(d._OFFSET_NBSP,!0);this.shapes=r,s.info("PS2ICO: shapes "+r);var i=t.getUint32(d._OFFSET_ATTRIB,!0);s.info("PS2ICO: attributes "+i.toString(16));if(i&d._ATTRIB_RLE)return s.error("PS2ICO: run-length encoding texture is not supported"),!1;var o=t.getFloat32(d._OFFSET_BFACE,!0);s.info("PS2ICO: back face clip "+o);var u=t.getUint32(d._OFFSET_NBVTX,!0);s.info("PS2ICO: vertices "+u);var a=d._OFFSET_VTX;this._vertices=new Array(r);for(var f=0;f<r;++f)this._vertices[f]=new Array(u*3);this._coord=new Array(u*2);for(var l=0;l<u;++l){for(f=0;f<r;++f){var c=t.getInt16(a+0,!0)/1024,h=-t.getInt16(a+2,!0)/1024,p=-t.getInt16(a+4,!0)/1024;this._vertices[f][l*3+0]=c,this._vertices[f][l*3+1]=h,this._vertices[f][l*3+2]=p,a+=8}var v=t.getInt16(a+0,!0)/4096,m=t.getInt16(a+2,!0)/4096,g=t.getInt16(a+4,!0)/4096;a+=8;var y=t.getInt16(a+0,!0)/4096,b=t.getInt16(a+2,!0)/4096;this._coord[l*2+0]=y,this._coord[l*2+1]=1-b,a+=4;var w=t.getUint32(a,!1);a+=4}s.info("PS2ICO: animation data start at 0x"+a.toString(16));var E=t.getUint32(a,!0);s.info("PS2ICO: sequences "+E);if(E!=1)return s.error("PS2ICO: nbseq must be 1"),!1;a+=4;var S=t.getUint32(a+0,!0),x=t.getFloat32(a+4,!0),T=t.getUint32(a+8,!0),N=t.getUint32(a+12,!0);s.info("PS2ICO: frames "+S),s.info("PS2ICO: speed "+x),s.info("PS2ICO: offset "+T),s.info("PS2ICO: nbksp "+N),this.frames=S,this._weights=new Array(S);for(l=0;l<S;++l)this._weights[l]=new Array(N);a+=16;for(l=0;l<N;++l){var C=t.getUint32(a+0,!0),k=t.getUint32(a+4,!0);a+=8,s.info("PS2ICO: animation "+C);var L=0,A=0;for(var O=0;O<k;++O){var M=t.getFloat32(a+0,!0),_=t.getFloat32(a+4,!0),D=M-L;if(D==0)L=M,A=_;else{var P=_-A,H=P/D;for(var B=L;B<M;++B)this._weights[B][l]=A,A+=H;L=B,A=_}s.info("PS2ICO: > "+M+","+_),a+=8}for(;L<60;++L)this._weights[L][l]=A}if(e.byteLength-a!=32768)return s.error("PS2ICO: texture data size is wrong"),!1;this._texture=new Array(65536);for(l=0;l<this._texture.length;l+=4){var j=t.getUint16(a,!0);a+=2,this._texture[l+0]=(j>>0&31)<<3,this._texture[l+1]=(j>>5&31)<<3,this._texture[l+2]=(j>>10&31)<<3,this._texture[l+3]=255}return!0},d.prototype.scale=function(e){for(var t=0;t<this.shapes;++t){var n=this._vertices[t];for(var r=0;r<n.length;++r)n[r]*=e}},d.prototype.getVertices=function(e){return this._vertices[e]},d.prototype.getCoords=function(){return this._coord},d.prototype.getTexture=function(){return this._texture},d.prototype.getWeights=function(e){return this._weights[e]},e.TmaModelPs2Ico=d,this.tma=s,this.TmaScreen=o,this.Tma2DScreen=u,this.Tma3DScreen=a,this.TmaModelPrimitives=f,this.TmaParticle=l,this.TmaSequencer=c,this.TmaMotionBvh=h,this.TmaModelPly=p,this.TmaModelPs2Ico=d,this.createScreen=function(e,t,n){return new o(e,t,n)},this.createBox=f.createBox,this.createCube=f.createCube,this.createPoints=f.createPoints,this.createSphere=f.createSphere}});