<html>
<head>
    <script src="../tma.js"></script>
    <script>
        tma.onload = function () {
            // All libraries are loaded asynchronously.
            tma.log("test.html: libraries must be loaded");
            var screen = new TmaScreen(640, 480);
            screen.attachTo(TmaScreen.BODY);
            screen.afterimage();
            screen.blur(0.25, 1.0, 1.0, 0, 2, false);

            function Snow (x, vy) {
                this.x = x;
                this.y = 0;
                this.vx = 0;
                this.vy = vy;
                this.s = 1;
            }

            Snow.GRAVITY = 10 / 1000;
            Snow.DRAG = 0.3;
            Snow.objects = [];

            Snow.emit = function () {
                var x = Math.random() * screen.width;
                var vy = Math.random() + 0.5;
                Snow.objects.push(new Snow(x, vy));
            };

            Snow.prototype.update = function () {
                this.vy += Snow.GRAVITY * this.s;
                this.vx *= 0.99;
                this.vy *= 0.99;
                this.x += this.vx;
                this.y += this.vy;
            };

            function main () {
                var data = screen.lock().data;
                for (var i = 0; i < screen.width * screen.height; i++) {
                    // RGBA
                    data[i * 4 + 0] = 0x00;
                    data[i * 4 + 1] = 0x00;
                    data[i * 4 + 2] = 0x00;
                    data[i * 4 + 3] = 0xff;
                }
                var length = Snow.objects.length;
                for (i = 0; i < length; i++) {
                    var snow = Snow.objects[i];
                    snow.update();
                    if (snow.y < screen.height) {
                        screen.setPixel(
                                ~~snow.x, ~~snow.y, 0xff, 0xff, 0xff, 0xff);
                    } else {
                        Snow.objects.splice(i--, 1);
                        length--;
                    }
                }
                screen.unlock();
                for (i = 0; i < 20; i++)
                    Snow.emit();
            }

            setInterval(main, 20);
        };
    </script>
</head>
</html>
