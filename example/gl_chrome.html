<html>
<head>
    <script src="../tma.js"></script>
    <script id="shader-vs" type="x-shader/x-vertex">
        attribute vec3 aVertexPosition;
        uniform mat4 uMVMatrix;
        uniform mat4 uPMatrix;
        uniform vec4 uColor;
        varying vec4 vColor;
        void main() {
            gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);
            vColor = uColor;
        }
    </script>
    <script id="shader-fs" type="x-shader/x-fragment">
        precision mediump float;
        varying vec4 vColor;
        void main() {
            gl_FragColor = vColor;
        }
    </script>
    <script>
        tma.extlibs = [ 'ext/gl-matrix.js', 'example/data/data_chrome.js' ];
        tma.onload = function () {
            var screen = new TmaScreen(TmaScreen.FULL_WIDTH,
                                       TmaScreen.FULL_HEIGHT,
                                       TmaScreen.MODE_3D);
            screen.attachTo(TmaScreen.BODY);

            // Initializes buffers.
            var resolution = 32;
            var circleVertices = screen.createBuffer(function (resolution) {
                var vertices = [ 0, 0, 0 ];
                for (var i = 0; i <= resolution; ++i) {
                    var w = 2.0 * Math.PI * i / resolution;
                    vertices =
                            vertices.concat([ Math.cos(w), Math.sin(w), 0.0 ]);
                }
                return vertices;
            } (resolution));
            circleVertices.items = resolution + 2;

            // Initializes program with shaders.
            var program = screen.createProgram('shader-vs', 'shader-fs');

            // Initializes matrices.
            var pMatrix = mat4.create();
            var mvMatrix = mat4.create();
            mat4.perspective(
                    45, screen.width / screen.height, 0.1, 1000.0, pMatrix);
            mat4.translate(pMatrix, [ 0.0, 0.0, -250.0 ]);
            mat4.identity(mvMatrix);

            // Initializes screen.
            screen.fillColor(0.0, 0.0, 0.0, 1.0);

            // Draws circle.
            program.setAttributeArray(
                    'aVertexPosition', circleVertices, 0, 3, 0);
            setInterval(function () {
                var mat = mat4;
                var prg = program;
                mat.rotate(pMatrix, 0.05, [ 0.1, 0.2, 0.0 ]);
                prg.setUniformMatrix('uPMatrix', pMatrix);
                screen.fillColor(0.0, 0.0, 0.0, 1.0);
                var data = data_chrome;
                var length = data.length;
                var mv = mvMatrix;
                var fan = Tma3DScreen.MODE_TRIANGLE_FAN;
                var items = circleVertices.items;
                for (var i = 0; i < length; ++i) {
                    var m = mat.create(mv);
                    var p = data[i];
                    mat.translate(m, [p[0], p[1], 0.0]);
                    prg.setUniformMatrix('uMVMatrix', m);
                    prg.setUniformVector('uColor', [p[2], p[3], p[4], p[5]]);
                    prg.drawArrays(fan, 0, items);
                }
                screen.flush();
            }, 20);
        };
    </script>
</head>
</html>
